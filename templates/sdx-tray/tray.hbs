<div class="sdx-tray {{#if isExpanded}}expanded{{/if}}" data-position="left">

    <!-- TRAY HANDLE -->
    <div class="tray-handle">
        <div class="tray-handle-content-container">

            <button class="tray-handle-button-toggle" title="Toggle Tray">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
            <button class="tray-handle-button-viewcycle" title="Toggle View Mode">
                <i class="fas {{#if (eq viewMode 'party')}}fa-users{{else}}fa-user{{/if}}"></i>
            </button>

            <!-- GM TOOLS -->
            {{#if isGM}}
            <button class="tray-handle-button-tool" data-action="leader" title="Choose Party Leader">
                <i class="fa-solid fa-crown"></i>
            </button>
            <button class="tray-handle-button-tool" data-action="marching" title="Marching Mode">
                <i class="fa-solid fa-person-walking"></i>
            </button>
            <button class="tray-handle-button-tool" data-action="formation" title="Formation Spawner">
                <i class="fa-solid fa-users-viewfinder"></i>
            </button>
            <button class="tray-handle-button-tool" data-action="add-pin" title="Add Pin">
                <i class="fa-solid fa-map-pin"></i>
            </button>
            <button class="tray-handle-button-tool" data-action="pin-list" title="Pin List">
                <i class="fa-solid fa-list"></i>
            </button>

            <button class="tray-handle-button-tool" data-action="light-tracker" title="Light Source Tracker">
                <i class="fa-solid fa-fire"></i>
            </button>



            {{#if showTomOverlays}}
            <button class="tray-handle-button-tool tom-overlay-manager-btn" data-action="tom-overlay-manager"
                title="Video Overlays">
                <i class="fa-solid fa-film"></i>
            </button>
            {{/if}}
            {{/if}}
            <button class="tray-handle-button-tool" data-action="carousing" title="Carousing">
                <i class="fa-solid fa-beer"></i>
            </button>
            <button class="tray-handle-button-tool" data-action="sdx-drawing" title="Drawing Tools">
                <i class="fa-solid fa-pencil"></i>
            </button>
            <button class="tray-handle-button-tool" data-action="sdx-coords" title="Toggle Coordinates">
                <i class="far fa-globe"></i>
            </button>
            <button class="tray-handle-button-tool{{#unless isGM}} active{{/unless}}" data-action="sdx-hex-tooltip"
                title="Hexplorer">
                <i class="fa-solid fa-hexagon-image"></i>
            </button>
            {{#if isGM}}
            <button class="tray-handle-button-tool{{#if hexFogActive}} active{{/if}}" data-action="sdx-hex-fog"
                title="Hex Fog">
                <i class="fa-solid fa-smog"></i>
            </button>
            {{/if}}
            {{#if isGM}}
            <button class="tray-handle-button-tool" data-action="sdx-roller" title="SDX Roller">
                <i class="fa-solid fa-dice"></i>
            </button>
            {{#if (or (and (eq viewMode 'hexes') (eq activeTileTab 'symbols')) (eq viewMode 'decor'))}}
            <button class="tray-handle-button-tool poi-undo-btn {{#unless canUndoPoi}}disabled{{/unless}}"
                data-action="poi-undo" title="Undo Last POI">
                <i class="fa-solid fa-rotate-left"></i>
            </button>
            <button class="tray-handle-button-tool poi-redo-btn {{#unless canRedoPoi}}disabled{{/unless}}"
                data-action="poi-redo" title="Redo POI">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
            <button class="tray-handle-button-tool poi-scale-btn" data-action="poi-scale-down"
                title="Decrease POI Size">
                <i class="fa-solid fa-minus"></i>
            </button>
            <button class="tray-handle-button-tool poi-scale-btn" data-action="poi-scale-up" title="Increase POI Size">
                <i class="fa-solid fa-plus"></i>
            </button>
            <button class="tray-handle-button-tool poi-transform-btn" data-action="poi-rotate-left" title="Rotate Left">
                <i class="fa-solid fa-rotate-left"></i>
            </button>
            <button class="tray-handle-button-tool poi-transform-btn" data-action="poi-rotate-right"
                title="Rotate Right">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
            <button class="tray-handle-button-tool poi-transform-btn {{#if poiMirror}}active{{/if}}"
                data-action="poi-mirror" title="Mirror Horizontal">
                <i class="fa-solid fa-left-right"></i>
            </button>
            {{/if}}
            {{/if}}

        </div>
    </div>

    <!-- TRAY CONTENT -->
    <div class="tray-content">

        <!-- GM TOOLS -->


        <!-- TRAY TABS -->
        <div class="tray-view-tabs">
            {{#if isGM}}
            <button class="tray-tab-button {{#if (eq viewMode 'scenes')}}active{{/if}}" data-view="scenes"
                title="Scenes View">
                <i class="fa-solid fa-images"></i> Scenes
            </button>
            {{else}}
            <button class="tray-tab-button {{#if (eq viewMode 'player')}}active{{/if}}" data-view="player"
                title="Player View">
                <i class="fa-solid fa-user"></i> Token
            </button>
            {{/if}}
            {{#if showTabParty}}
            <button class="tray-tab-button {{#if (eq viewMode 'party')}}active{{/if}}" data-view="party"
                title="Party View">
                <i class="fa-solid fa-users"></i> Party
            </button>
            {{/if}}
            {{#if isGM}}
            <button class="tray-tab-button {{#if (eq viewMode 'pins')}}active{{/if}}" data-view="pins"
                title="Journal Pins">
                <i class="fa-solid fa-map-pin"></i> Pins
            </button>
            {{/if}}
            <button class="tray-tab-button {{#if (eq viewMode 'notes')}}active{{/if}}" data-view="notes"
                title="Placeable Notes">
                <i class="fa-solid fa-sticky-note"></i> Notes
            </button>
        </div>
        {{#if (or isGM canPlayerPaint)}}
        <div class="tray-view-tabs tray-view-tabs-row2">
            {{#if isGM}}
            <button class="tray-tab-button {{#if (eq viewMode 'hexes')}}active{{/if}}" data-view="hexes"
                title="Hex Painter">
                <i class="fas fa-border-all"></i> Hexes
            </button>
            {{/if}}
            <button class="tray-tab-button {{#if (eq viewMode 'dungeons')}}active{{/if}}" data-view="dungeons"
                title="Dungeon Painter{{#unless isGM}} (GM Online){{/unless}}">
                <i class="fas fa-dungeon"></i> Dungeons
            </button>
            {{#if isGM}}
            <button class="tray-tab-button {{#if (eq viewMode 'decor')}}active{{/if}}" data-view="decor"
                title="Decor Painter">
                <i class="fas fa-couch"></i> Decor
            </button>
            {{/if}}
        </div>
        {{/if}}

        <!-- PANELS -->
        <div class="tray-panel-wrapper">

            <!-- Selection Info - Only shown when multiple tokens are selected -->
            {{#if showSelectionBox}}
            <div class="tray-selection-wrapper">
                <div class="tray-selection-count">{{selectionCount}} tokens selected</div>
                <div class="tray-selection-actions">
                    <button class="tray-selection-button button-clear"
                        data-tooltip="Clear all selections">Clear</button>
                </div>
            </div>
            {{/if}}

            <!-- PLAYER TAB -->
            <div class="tray-view-content player-view {{#unless (eq viewMode 'player')}}hidden{{/unless}}">
                {{#if actor}}
                <!-- CHARACTER PANEL -->
                <div class="panel-container" data-panel="character" data-clickable="true">
                    <div class="character-panel">
                        <div class="character-portrait" style="background-image: url('{{actor.img}}')">
                            {{#if actorHP}}
                            <div class="health-overlay" style="height: {{healthOverlayHeight actorHP}}"></div>
                            {{#if (eq actorHP.value 0)}}
                            <i class="fa-solid fa-skull death-skull"></i>
                            {{/if}}
                            {{/if}}
                        </div>
                        <div class="character-info">
                            <div class="character-name">{{actor.name}}</div>
                            <div class="character-details">
                                {{#if actor.system.level.value}}
                                <span class="character-level">Level {{actor.system.level.value}}</span>
                                {{/if}}
                            </div>
                            {{#if actorHP}}
                            <div class="character-hp-bar">
                                <div class="hp-current">
                                    <span class="hp-value">{{actorHP.value}}</span>
                                </div>
                                <div class="hp-fill {{actorHealthbarStatus}}" style="width: {{actorHP.percent}}%"></div>
                                <div class="hp-max">
                                    <span class="hp-value">{{actorHP.max}}</span>
                                </div>
                            </div>
                            {{/if}}
                        </div>
                    </div>
                </div>
                {{else}}
                <div class="no-character-message">
                    <p>NO TOKEN SELECTED OR OWNED</p>
                    <p>Select an owned token to get started.</p>
                </div>
                {{/if}}
            </div>

            <!-- SCENES TAB (GM ONLY) -->
            {{#if isGM}}
            <div class="tray-view-content scenes-view {{#unless (eq viewMode 'scenes')}}hidden{{/unless}}"
                style="overflow-y: hidden; display: flex; flex-direction: column;">

                <!-- Create/Stop Header -->
                <div class="scenes-header" style="flex: 0 0 auto; padding: 10px;">
                    <button class="tray-btn-full" data-action="create-scene">
                        <i class="fas fa-plus"></i> Create New Scene
                    </button>
                    <button class="tray-btn-full folder-create-btn" data-action="create-folder">
                        <i class="fas fa-folder-plus"></i> Create New Folder
                    </button>
                    {{#if tomActiveSceneId}}
                    <button class="tray-btn-full danger mt-2" data-action="stop-broadcast">
                        <i class="fas fa-stop"></i> Stop Broadcasting
                    </button>
                    {{/if}}
                </div>

                <!-- Scenes List -->
                <div class="scenes-list-scroll"
                    style="flex: 1; overflow-y: auto; scrollbar-width: thin; padding: 0 10px 10px 10px;">

                    {{!-- Render Folders --}}
                    {{#each tomFolders}}
                    <div class="scene-folder" data-folder-id="{{this.id}}">
                        <div class="scene-folder-header {{#if this.collapsed}}collapsed{{/if}}"
                            data-action="toggle-folder" data-folder-id="{{this.id}}">
                            <i
                                class="fas {{#if this.collapsed}}fa-caret-right{{else}}fa-caret-down{{/if}} scene-folder-chevron"></i>
                            <i
                                class="fas {{#if this.collapsed}}fa-folder{{else}}fa-folder-open{{/if}} scene-folder-icon"></i>
                            <span class="scene-folder-name">{{this.name}}</span>
                            <span class="scene-folder-count">({{this.scenes.length}})</span>
                            <div class="scene-folder-actions">
                                <button class="scene-action-btn" data-action="rename-folder"
                                    data-folder-id="{{this.id}}" data-folder-name="{{this.name}}" title="Rename Folder">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button class="scene-action-btn danger" data-action="delete-folder"
                                    data-folder-id="{{this.id}}" data-folder-name="{{this.name}}" title="Delete Folder">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="scene-folder-content {{#if this.collapsed}}hidden{{/if}}"
                            data-folder-id="{{this.id}}">
                            {{#if this.scenes.length}}
                            {{#each this.scenes}}
                            <div class="scene-card {{#if (eq this.id ../../tomActiveSceneId)}}active{{/if}}"
                                data-scene-id="{{this.id}}" draggable="true">
                                <div class="scene-card-activate" title="Click to Broadcast">
                                    <div class="scene-card-thumb">
                                        {{#if this.isVideo}}
                                        <video src="{{this.background}}" muted loop preload="metadata"
                                            class="scene-thumb-video"></video>
                                        {{else}}
                                        <div class="scene-thumb-image"
                                            style="background-image: url('{{this.background}}')">
                                        </div>
                                        {{/if}}
                                        {{#if (eq this.id ../../tomActiveSceneId)}}
                                        <div class="scene-playing-overlay">
                                            <i class="fas fa-play"></i>
                                        </div>
                                        {{/if}}
                                    </div>
                                    <div class="scene-card-info">
                                        <div class="scene-name">{{this.name}}</div>
                                        {{#if this.isArena}}
                                        <div class="scene-tag arena">Arena</div>
                                        {{/if}}
                                    </div>
                                </div>
                                <div class="scene-card-actions">
                                    <button class="scene-action-btn" data-action="edit-scene" title="Edit Scene">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                    <button class="scene-action-btn danger" data-action="delete-scene"
                                        title="Delete Scene">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {{/each}}
                            {{else}}
                            <div class="scene-folder-empty">Drag scenes here</div>
                            {{/if}}
                        </div>
                    </div>
                    {{/each}}

                    {{!-- Uncategorized Scenes (no folderId) --}}
                    {{#if tomFolders.length}}
                    <div class="scene-uncat-header">Uncategorized</div>
                    {{/if}}
                    <div class="scene-uncat-container" data-folder-id="">
                        {{#each tomScenes}}
                        {{#unless this.folderId}}
                        <div class="scene-card {{#if (eq this.id ../tomActiveSceneId)}}active{{/if}}"
                            data-scene-id="{{this.id}}" draggable="true">
                            <div class="scene-card-activate" title="Click to Broadcast">
                                <div class="scene-card-thumb">
                                    {{#if this.isVideo}}
                                    <video src="{{this.background}}" muted loop preload="metadata"
                                        class="scene-thumb-video"></video>
                                    {{else}}
                                    <div class="scene-thumb-image" style="background-image: url('{{this.background}}')">
                                    </div>
                                    {{/if}}
                                    {{#if (eq this.id ../tomActiveSceneId)}}
                                    <div class="scene-playing-overlay">
                                        <i class="fas fa-play"></i>
                                    </div>
                                    {{/if}}
                                </div>
                                <div class="scene-card-info">
                                    <div class="scene-name">{{this.name}}</div>
                                    {{#if this.isArena}}
                                    <div class="scene-tag arena">Arena</div>
                                    {{/if}}
                                </div>
                            </div>
                            <div class="scene-card-actions">
                                <button class="scene-action-btn" data-action="edit-scene" title="Edit Scene">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button class="scene-action-btn danger" data-action="delete-scene" title="Delete Scene">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {{/unless}}
                        {{/each}}
                    </div>

                    {{!-- Empty state --}}
                    {{#unless tomScenes.length}}
                    {{#unless tomFolders.length}}
                    <div class="no-content-message">
                        <p>No Scenes Created</p>
                    </div>
                    {{/unless}}
                    {{/unless}}
                </div>
            </div>
            {{/if}}

            <!-- PARTY TAB -->
            <div class="tray-view-content party-view {{#unless (eq viewMode 'party')}}hidden{{/unless}}">

                <!-- Party Toolbar -->
                <div class="tray-tools-toolbar">
                    {{#if isGM}}
                    <button class="tray-tools-button" data-action="select-party">
                        <i class="fa-solid fa-users-viewfinder"></i> Select Party
                    </button>
                    {{else}}
                    <button class="tray-tools-button" data-action="select-party">
                        <i class="fa-solid fa-users-viewfinder"></i> Select Owned
                    </button>
                    {{/if}}
                </div>

                <!-- PARTY HEALTH -->
                <div class="party-health-card">
                    <div class="party-health-card-info">
                        <div class="party-health-card-title">Party Health</div>
                        <div class="party-health-card-details">
                            <div class="party-hp-bar party-health-card-hp-bar">
                                <div class="hp-current">
                                    <span class="hp-value">{{partyRemainingHP}}</span>
                                </div>
                                <div class="hp-fill {{partyHealthbarStatus}}"
                                    style="width: {{multiply (divide partyRemainingHP partyTotalHP) 100}}%"></div>
                                <div class="hp-max">
                                    <span class="hp-value">{{partyTotalHP}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PARTY CHARACTERS -->
                {{#each partyTokens as |member|}}
                <div class="party-card {{#if member.isOwner}}party-card-clickable{{/if}} {{#if member.isSelected}}party-card-selected{{/if}}"
                    data-token-id="{{member.id}}">
                    <div class="party-card-image party-card-clickable" style="background-image: url('{{member.img}}')"
                        title="Click to select token">
                        {{#if member.hp}}
                        <div class="health-overlay" style="height: {{healthOverlayHeight member.hp}}"></div>
                        {{#if (eq member.hp.value 0)}}
                        <i class="fa-solid fa-skull death-skull"></i>
                        {{/if}}
                        {{/if}}
                    </div>
                    <div class="party-card-info">
                        <div class="party-card-name">{{member.name}}</div>
                        <div class="party-card-details">
                            {{#if member.hp}}
                            <div class="party-hp-bar">
                                <div class="hp-current">
                                    <span class="hp-value">{{member.hp.value}}</span>
                                </div>
                                <div class="hp-fill {{member.healthbarStatus}}" style="width: {{member.hp.percent}}%">
                                </div>
                                <div class="hp-max">
                                    <span class="hp-value">{{member.hp.max}}</span>
                                </div>
                            </div>
                            {{/if}}
                        </div>
                    </div>
                    <div class="party-card-actions">
                        {{#if member.isOwner}}
                        <i class="fa-solid fa-feather-alt open-sheet" title="Open Character Sheet"></i>
                        {{/if}}
                    </div>
                </div>
                {{else}}
                <div class="no-party-message">
                    <p>- No Party Tokens to Display -</p>
                    <p>Add tokens to the scene to get started</p>
                </div>
                {{/each}}

                <!-- MONSTER AND NPC CHARACTERS -->
                {{#if (or isGM (and npcTokens.length (not hideNpcsFromPlayers)))}}
                {{#if npcTokens.length}}
                <div class="section-divider">
                    <span class="divider-text">MONSTERS & NPCs</span>
                    {{#if isGM}}
                    <button class="npc-visibility-toggle" data-action="toggle-npc-visibility"
                        title="{{#if hideNpcsFromPlayers}}Show NPCs to Players{{else}}Hide NPCs from Players{{/if}}">
                        <i class="fas {{#if hideNpcsFromPlayers}}fa-eye-slash{{else}}fa-eye{{/if}}"></i>
                    </button>
                    {{/if}}
                </div>

                {{#each npcTokens as |npc|}}
                <div class="party-card party-npc-card {{#if npc.isSelected}}party-card-selected{{/if}}"
                    data-token-id="{{npc.id}}">
                    <div class="party-card-image party-card-clickable" style="background-image: url('{{npc.img}}')"
                        title="Click to select token">
                        {{#if npc.hp}}
                        <div class="health-overlay" style="height: {{healthOverlayHeight npc.hp}}"></div>
                        {{#if (eq npc.hp.value 0)}}
                        <i class="fa-solid fa-skull death-skull"></i>
                        {{/if}}
                        {{/if}}
                    </div>
                    <div class="party-card-info">
                        <div class="party-card-name">{{npc.name}}</div>
                        <div class="party-card-details">
                            {{#if npc.hp}}
                            <div class="party-hp-bar">
                                <div class="hp-current">
                                    <span class="hp-value">{{npc.hp.value}}</span>
                                </div>
                                <div class="hp-fill {{npc.healthbarStatus}}" style="width: {{npc.hp.percent}}%"></div>
                                <div class="hp-max">
                                    <span class="hp-value">{{npc.hp.max}}</span>
                                </div>
                            </div>
                            {{/if}}
                        </div>
                    </div>
                    <div class="party-card-actions">
                        <i class="fa-solid fa-feather-alt open-sheet" title="Open Character Sheet"></i>
                    </div>
                </div>
                {{/each}}
                {{/if}}
                {{/if}}
            </div>

            <!-- PINS TAB -->
            <div class="tray-view-content pins-view {{#unless (eq viewMode 'pins')}}hidden{{/unless}}"
                style="overflow-y: hidden; display: flex; flex-direction: column;">

                <!-- Search Bar -->
                <div class="pin-search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" class="pin-search-input" placeholder="Search pins..." value="{{pinSearchTerm}}">
                </div>

                <!-- Pin List Content -->
                <div class="pin-list-scroll-container"
                    style="flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(255, 255, 255, 0.2) rgba(0, 0, 0, 0.1);">
                    {{#if pins.length}}
                    <ul class="sdx-pin-list">
                        {{#each pins}}
                        <li class="pin-entry flexrow" data-id="{{this.id}}" data-x="{{this.x}}" data-y="{{this.y}}"
                            style="align-items: stretch; padding: 0;">
                            <div
                                style="flex: 0 0 50px; width: 50px; display: flex; align-items: center; justify-content: center; border-right: 1px solid #85733f;">
                                <div class="pin-icon"
                                    style="display: flex; justify-content: center; align-items: center; background-color: {{this.backgroundColor}}; border: 2px solid {{this.borderColor}}; border-radius: {{this.borderRadius}}; width: 32px; height: 32px; box-shadow: 0 0 4px rgba(0,0,0,0.5);">
                                    {{#if (eq this.displayType "image")}}
                                    <img src="{{this.displayContent}}"
                                        style="display: block; width: 20px; height: 20px; object-fit: contain;"
                                        alt="Icon" />
                                    {{else if (eq this.displayType "icon")}}
                                    <i class="{{this.displayClass}}" style="{{this.displayStyle}} font-size: 16px;"></i>
                                    {{else if (eq this.displayType "text")}}
                                    <span
                                        style="{{this.displayStyle}} font-size: 14px; line-height: 1;">{{this.displayContent}}</span>
                                    {{/if}}
                                </div>
                            </div>
                            <div class="pin-info flexcol"
                                style="flex: 1; min-width: 0; justify-content: center; padding: 4px 8px;">
                                <span class="pin-name">{{this.name}}</span>
                                {{#if this.pageName}}
                                <span class="pin-page-name">{{this.pageName}}</span>
                                {{/if}}
                                <div class="pin-controls flexrow">
                                    <a class="pin-control" data-action="ping-pin" title="Ping Pin"><i
                                            class="fa-solid fa-bullseye"></i></a>
                                    <a class="pin-control" data-action="bring-players" title="Bring Players Here"><i
                                            class="fa-solid fa-location-crosshairs"></i></a>
                                    <a class="pin-control" data-action="pan" title="Pan to Pin"><i
                                            class="fas fa-crosshairs"></i></a>
                                    <a class="pin-control" data-action="copy-style" title="Copy Style"><i
                                            class="fa-solid fa-copy"></i></a>
                                    <a class="pin-control" data-action="paste-style" title="Paste Style"><i
                                            class="fa-solid fa-paste"></i></a>
                                    <a class="pin-control" data-action="duplicate-pin" title="Duplicate Pin"><i
                                            class="fa-solid fa-clone"></i></a>
                                    <a class="pin-control" data-action="edit-pin" title="Edit Pin"><i
                                            class="fa-solid fa-pen"></i></a>
                                    <a class="pin-control danger" data-action="delete-pin" title="Delete Pin"><i
                                            class="fa-solid fa-trash" style="color: #ff3333;"></i></a>
                                </div>
                            </div>
                            <div class="pin-sidebar flexcol"
                                style="flex: 0 0 50px; width: 50px; border-left: 1px solid #85733f; align-items: center; justify-content: center; gap: 4px; margin: 0; padding: 0;">
                                <a class="pin-control toggle-gm-only" data-action="toggle-gm-only"
                                    title="{{#if this.gmOnly}}Make Visible to Players{{else}}Make GM Only{{/if}}">
                                    <i class="fa-solid {{#if this.gmOnly}}fa-eye-slash{{else}}fa-eye{{/if}}" {{#if
                                        this.gmOnly}}style="color: #ff3333;" {{else}}style="color: #44cc44;"
                                        {{/if}}></i>
                                </a>
                                <a class="pin-control toggle-vision" data-action="toggle-vision"
                                    title="Toggle Require Line of Sight: {{#if this.requiresVision}}ON{{else}}OFF{{/if}}">
                                    <i class="fa-solid fa-binoculars" {{#if this.requiresVision}}style="color: #44cc44;"
                                        {{else}}style="color: #888888;" {{/if}} style="font-size: 0.9em;"></i>
                                </a>
                            </div>
                        </li>
                        {{/each}}
                    </ul>
                    {{/if}}

                    {{#if mapNotes.length}}
                    <div class="section-divider">
                        <span class="divider-text">MAP NOTES</span>
                    </div>
                    <ul class="sdx-pin-list map-notes-list">
                        {{#each mapNotes}}
                        <li class="pin-entry map-note-entry flexrow" data-id="{{this.id}}" data-uuid="{{this.uuid}}"
                            data-x="{{this.x}}" data-y="{{this.y}}" style="align-items: stretch; padding: 0;">
                            <div
                                style="flex: 0 0 50px; width: 50px; display: flex; align-items: center; justify-content: center; border-right: 1px solid #85733f;">
                                <div class="pin-icon"
                                    style="display: flex; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.5); border: 2px solid #85733f; border-radius: 4px; width: 32px; height: 32px;">
                                    <img src="{{this.img}}"
                                        style="display: block; width: 24px; height: 24px; object-fit: contain;"
                                        alt="Icon" />
                                </div>
                            </div>
                            <div class="pin-info flexcol"
                                style="flex: 1; min-width: 0; justify-content: center; padding: 4px 8px;">
                                <span class="pin-name">{{this.name}}</span>
                                <div class="pin-controls flexrow">
                                    <a class="map-note-control" data-action="open" title="Open Note"><i
                                            class="fa-solid fa-book-open"></i></a>
                                    <a class="map-note-control" data-action="pan" title="Pan to Note"><i
                                            class="fas fa-crosshairs"></i></a>
                                    {{#if this.canDelete}}
                                    <a class="map-note-control danger" data-action="delete" title="Delete Note"><i
                                            class="fa-solid fa-trash" style="color: #ff3333;"></i></a>
                                    {{/if}}
                                </div>
                            </div>
                        </li>
                        {{/each}}
                    </ul>
                    {{/if}}

                    {{#unless (or pins.length mapNotes.length)}}
                    <div class="no-character-message">
                        <p>No Pins or Notes Found</p>
                        <p>Add pins or map notes to the scene to see them here</p>
                    </div>
                    {{/unless}}
                </div>
            </div>
            <!-- NOTES TAB -->
            <div class="tray-view-content notes-view {{#unless (eq viewMode 'notes')}}hidden{{/unless}}"
                style="overflow-y: hidden; display: flex; flex-direction: column;">

                <!-- Note List Content -->
                <div class="note-list-scroll-container"
                    style="flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(255, 255, 255, 0.2) rgba(0, 0, 0, 0.1);">
                    {{#if notes.length}}
                    <ul class="sdx-note-list">
                        {{#each notes}}
                        <li class="note-entry {{#if (and ../isGM (not this.isVisible))}}hidden-note{{/if}}"
                            data-id="{{this.id}}" data-x="{{this.x}}" data-y="{{this.y}}">
                            <div class="note-header">
                                <span class="toggle-icon"><i class="fas fa-chevron-right"></i></span>
                                <div class="note-icon"><i class="{{this.icon}}"></i></div>
                                <span class="note-name">{{this.name}}</span>
                                <div class="note-controls">
                                    {{#if ../isGM}}
                                    <a class="note-control" data-action="toggle-visibility"
                                        title="{{#if this.isVisible}}Make Hidden{{else}}Make Visible{{/if}}">
                                        <i class="fas {{#if this.isVisible}}fa-eye{{else}}fa-eye-slash{{/if}}"
                                            style="{{#if this.isVisible}}color: #4ade80;{{else}}color: #999;{{/if}}"></i>
                                    </a>
                                    <a class="note-control" data-action="rename" title="Rename Note"><i
                                            class="fas fa-pen"></i></a>
                                    <a class="note-control danger" data-action="delete" title="Delete Note"><i
                                            class="fas fa-times" style="color: #ff3333;"></i></a>
                                    {{/if}}
                                    <a class="note-control" data-action="pan" title="Pan to Object"><i
                                            class="fas fa-crosshairs"></i></a>
                                </div>
                            </div>
                            <div class="note-content hidden">
                                {{{this.content}}}
                            </div>
                        </li>
                        {{/each}}
                    </ul>
                    {{else}}
                    <div class="no-character-message">
                        <p>No Notes Found</p>
                        <p>Add notes to placeables to see them here</p>
                    </div>
                    {{/if}}
                </div>

                {{#if isGM}}
                <div class="tray-footer-message">
                    Right click to edit a note content
                </div>
                {{/if}}

            </div>

            <!-- HEXES TAB (GM ONLY) -->
            {{#if isGM}}
            <div class="tray-view-content hexes-view {{#unless (eq viewMode 'hexes')}}hidden{{/unless}}"
                style="overflow-y: hidden; display: flex; flex-direction: column;">

                <!-- Format Map Controls -->
                <div class="hex-format-section">
                    <div class="hex-format-buttons">
                        <button class="hex-format-btn" data-action="hex-format-scene">
                            <i class="fas fa-ruler-combined"></i> Format Map
                        </button>
                        <button class="hex-flatten-btn" data-action="hex-flatten-all">
                            <i class="fas fa-layer-group"></i> Flatten Hexagons
                        </button>
                    </div>
                    <div class="hex-format-controls hidden">
                        <div class="hex-slider-row">
                            <label>Width</label>
                            <input type="range" name="hex-columns" min="5" max="50" step="1" value="{{hexColumns}}">
                            <span class="hex-slider-value">{{hexColumns}}</span>
                        </div>
                        <div class="hex-slider-row">
                            <label>Height</label>
                            <input type="range" name="hex-rows" min="5" max="50" step="1" value="{{hexRows}}">
                            <span class="hex-slider-value">{{hexRows}}</span>
                        </div>
                        <button class="hex-apply-btn" data-action="hex-apply-format">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                </div>

                <!-- Tile Search Filter -->
                <div class="hex-search-section">
                    <input type="text" class="hex-search-input" placeholder="Search tiles..."
                        value="{{hexSearchFilter}}" />
                </div>

                <!-- Effect Toggles -->
                <div class="hex-effects-section">
                    <div class="hex-effects-grid">
                        <label class="hex-fx-toggle">
                            <input type="checkbox" class="hex-water-checkbox" {{#if waterEffect}}checked{{/if}} />
                            <span><i class="fas fa-water"></i> Water</span>
                        </label>
                        <label class="hex-fx-toggle">
                            <input type="checkbox" class="hex-wind-checkbox" {{#if windEffect}}checked{{/if}} />
                            <span><i class="fas fa-wind"></i> Wind</span>
                        </label>
                        <label class="hex-fx-toggle">
                            <input type="checkbox" class="hex-fog-checkbox" {{#if fogAnimation}}checked{{/if}} />
                            <span><i class="fas fa-cloud"></i> Fog</span>
                        </label>
                        <label class="hex-fx-toggle">
                            <input type="checkbox" class="hex-tint-checkbox" {{#if tintEnabled}}checked{{/if}} />
                            <span><i class="fas fa-palette"></i> Tinted</span>
                        </label>
                        <label class="hex-fx-toggle">
                            <input type="checkbox" class="hex-bw-checkbox" {{#if bwEffect}}checked{{/if}} />
                            <span><i class="fas fa-adjust"></i> B&W</span>
                        </label>
                    </div>
                </div>

                <!-- Procedural Generator (hidden on symbols tab) -->
                <div class="hex-generator-section {{#if (eq activeTileTab 'symbols')}}hidden{{/if}}">
                    <button class="hex-generator-toggle-btn" data-action="hex-generator-toggle">
                        <i class="fas fa-dice-d20"></i> Procedural Generator
                    </button>
                    <div class="hex-generator-controls hidden">
                        <div class="hex-gen-slider-row">
                            <label><i class="fas fa-water"></i> Water</label>
                            <input type="range" name="hex-gen-water" min="-50" max="50" step="5" value="0">
                            <span class="hex-gen-slider-value">0</span>
                        </div>
                        <div class="hex-gen-slider-row">
                            <label><i class="fas fa-tree"></i> Vegetation</label>
                            <input type="range" name="hex-gen-green" min="-50" max="50" step="5" value="0">
                            <span class="hex-gen-slider-value">0</span>
                        </div>
                        <div class="hex-gen-slider-row">
                            <label><i class="fas fa-mountain"></i> Mountains</label>
                            <input type="range" name="hex-gen-mountain" min="-50" max="50" step="5" value="0">
                            <span class="hex-gen-slider-value">0</span>
                        </div>
                        <div class="hex-gen-slider-row">
                            <label><i class="fas fa-sun"></i> Desert</label>
                            <input type="range" name="hex-gen-desert" min="-50" max="50" step="5" value="0">
                            <span class="hex-gen-slider-value">0</span>
                        </div>
                        <div class="hex-gen-slider-row">
                            <label><i class="fas fa-frog"></i> Swamp</label>
                            <input type="range" name="hex-gen-swamp" min="-50" max="50" step="5" value="0">
                            <span class="hex-gen-slider-value">0</span>
                        </div>
                        <div class="hex-gen-slider-row">
                            <label><i class="fas fa-skull"></i> Badlands</label>
                            <input type="range" name="hex-gen-badlands" min="-50" max="50" step="5" value="0">
                            <span class="hex-gen-slider-value">0</span>
                        </div>
                        <div class="hex-gen-slider-row">
                            <label><i class="fas fa-snowflake"></i> Snow</label>
                            <input type="range" name="hex-gen-snow" min="-50" max="50" step="5" value="0">
                            <span class="hex-gen-slider-value">0</span>
                        </div>
                        <div class="hex-gen-seed-row">
                            <label><i class="fas fa-seedling"></i> Seed</label>
                            <input type="text" name="hex-gen-seed" class="hex-gen-seed-input" placeholder="Random"
                                value="">
                        </div>
                        <div class="hex-gen-buttons">
                            <button class="hex-gen-btn hex-gen-generate-btn" data-action="hex-generate">
                                <i class="fas fa-magic"></i> Generate
                            </button>
                            <button class="hex-gen-btn hex-gen-clear-btn" data-action="hex-clear">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tile Tabs -->
                <div class="hex-tile-tabs">
                    <button class="hex-tile-tab {{#if (eq activeTileTab 'default')}}active{{/if}}"
                        data-tile-tab="default">Default</button>
                    <button class="hex-tile-tab {{#if (eq activeTileTab 'colored')}}active{{/if}}"
                        data-tile-tab="colored">Colored</button>
                    <button class="hex-tile-tab {{#if (eq activeTileTab 'custom')}}active{{/if}}"
                        data-tile-tab="custom">Custom</button>
                    <button class="hex-tile-tab {{#if (eq activeTileTab 'symbols')}}active{{/if}}"
                        data-tile-tab="symbols">POI</button>
                </div>

                <!-- Tile Grid -->
                <div class="hex-tile-scroll"
                    style="flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.2) rgba(0,0,0,0.1);">

                    <!-- Colored Tile Info (only shown on colored tab) -->
                    {{#if (eq activeTileTab 'colored')}}
                    <div class="hex-custom-size-section">
                        <div class="hex-custom-folder-hint">
                            <i class="fas fa-info-circle"></i> Size: {{coloredTileWidth}}×{{coloredTileHeight}}
                        </div>
                    </div>
                    {{/if}}

                    <!-- POI Tile Info (only shown on symbols tab) -->
                    {{#if (eq activeTileTab 'symbols')}}
                    <div class="hex-custom-size-section poi-info-section">
                        <div class="hex-custom-folder-hint">
                            <i class="fas fa-info-circle"></i> POI paint on top · Scale: {{poiScalePercent}}%
                        </div>
                    </div>
                    {{/if}}

                    <!-- Custom Tile Size Controls (only shown on custom tab) -->
                    {{#if (eq activeTileTab 'custom')}}
                    <div class="hex-custom-size-section">
                        <div class="hex-custom-size-row">
                            <label>W:</label>
                            <input type="number" class="hex-custom-size-input" name="custom-tile-width" min="50"
                                max="1000" step="1" value="{{customTileWidth}}">
                            <label>H:</label>
                            <input type="number" class="hex-custom-size-input" name="custom-tile-height" min="50"
                                max="1000" step="1" value="{{customTileHeight}}">
                        </div>
                        <div class="hex-custom-folder-hint">
                            <i class="fas fa-info-circle"></i> Add tiles to <code>Data/hexes/</code>
                        </div>
                    </div>
                    {{/if}}

                    <!-- Default Tiles Grid -->
                    <div class="hex-tile-grid {{#unless (eq activeTileTab 'default')}}hidden{{/unless}}"
                        data-tile-panel="default">
                        {{#each hexTiles}}
                        <div class="hex-tile-thumb {{#if this.active}}active{{/if}}" data-tile="{{this.path}}"
                            title="{{this.label}}">
                            <img src="{{this.src}}" alt="{{this.label}}" loading="lazy" />
                            <span class="hex-tile-label">{{this.label}}</span>
                        </div>
                        {{/each}}
                    </div>

                    <!-- Colored Tiles Grid (folder-based) -->
                    <div class="hex-tile-colored-panel {{#unless (eq activeTileTab 'colored')}}hidden{{/unless}}"
                        data-tile-panel="colored">
                        {{#if hexColoredFolders.length}}
                        {{#each hexColoredFolders}}
                        <div class="hex-colored-folder" data-folder="{{this.folder}}">
                            <div class="hex-colored-folder-header {{#if this.collapsed}}collapsed{{/if}}"
                                data-action="toggle-colored-folder" data-folder="{{this.folder}}">
                                <i
                                    class="fas {{#if this.collapsed}}fa-caret-right{{else}}fa-caret-down{{/if}} hex-folder-chevron"></i>
                                <i
                                    class="fas {{#if this.collapsed}}fa-folder{{else}}fa-folder-open{{/if}} hex-folder-icon"></i>
                                <span class="hex-folder-name">{{this.label}}</span>
                                <span class="hex-folder-count">({{this.tiles.length}})</span>
                            </div>
                            <div class="hex-tile-grid hex-colored-folder-content {{#if this.collapsed}}hidden{{/if}}">
                                {{#each this.tiles}}
                                <div class="hex-tile-thumb {{#if this.active}}active{{/if}}" data-tile="{{this.path}}"
                                    title="{{this.label}}{{#if this.biome}} ({{this.biome}}){{/if}}">
                                    <img src="{{this.src}}" alt="{{this.label}}" loading="lazy" />
                                    <span class="hex-tile-label">{{this.label}}</span>
                                </div>
                                {{/each}}
                            </div>
                        </div>
                        {{/each}}
                        {{else}}
                        <div class="hex-no-custom-tiles">
                            <p><i class="fas fa-palette"></i></p>
                            <p>No colored tiles found</p>
                        </div>
                        {{/if}}
                    </div>

                    <!-- Custom Tiles Grid -->
                    <div class="hex-tile-grid {{#unless (eq activeTileTab 'custom')}}hidden{{/unless}}"
                        data-tile-panel="custom">
                        {{#if hexCustomTiles.length}}
                        {{#each hexCustomTiles}}
                        <div class="hex-tile-thumb {{#if this.active}}active{{/if}}" data-tile="{{this.path}}"
                            title="{{this.label}}{{#if this.biome}} ({{this.biome}}){{/if}}">
                            <img src="{{this.src}}" alt="{{this.label}}" loading="lazy" />
                            <span class="hex-tile-label">{{this.label}}</span>
                            {{#if this.biome}}<span class="hex-tile-biome">{{this.biome}}</span>{{/if}}
                        </div>
                        {{/each}}
                        {{else}}
                        <div class="hex-no-custom-tiles">
                            <p><i class="fas fa-folder-open"></i></p>
                            <p>No custom tiles found</p>
                            <p class="hex-custom-hint">Add .png or .webp files to:<br><code>Data/hexes/</code></p>
                            <p class="hex-custom-hint">Biome folders:<br>
                                <code>water</code>, <code>vegetation</code>, <code>mountains</code>,<br>
                                <code>desert</code>, <code>swamp</code>, <code>badlands</code>
                            </p>
                        </div>
                        {{/if}}
                    </div>

                    <!-- Symbol Tiles Grid (folder-based) -->
                    <div class="hex-tile-symbols-panel {{#unless (eq activeTileTab 'symbols')}}hidden{{/unless}}"
                        data-tile-panel="symbols">
                        {{#if hexSymbolFolders.length}}
                        {{#each hexSymbolFolders}}
                        <div class="hex-symbol-folder" data-folder="{{this.folder}}">
                            <div class="hex-symbol-folder-header {{#if this.collapsed}}collapsed{{/if}}"
                                data-action="toggle-symbol-folder" data-folder="{{this.folder}}">
                                <i
                                    class="fas {{#if this.collapsed}}fa-caret-right{{else}}fa-caret-down{{/if}} hex-folder-chevron"></i>
                                <i
                                    class="fas {{#if this.collapsed}}fa-folder{{else}}fa-folder-open{{/if}} hex-folder-icon"></i>
                                <span class="hex-folder-name">{{this.label}}</span>
                                <span class="hex-folder-count">({{this.tiles.length}})</span>
                            </div>
                            <div class="hex-tile-grid hex-symbol-folder-content {{#if this.collapsed}}hidden{{/if}}">
                                {{#each this.tiles}}
                                <div class="hex-tile-thumb {{#if this.active}}active{{/if}}" data-tile="{{this.path}}"
                                    title="{{this.label}}{{#if this.category}} ({{this.category}}){{/if}}">
                                    <img src="{{this.src}}" alt="{{this.label}}" loading="lazy" />
                                    <span class="hex-tile-label">{{this.label}}</span>
                                </div>
                                {{/each}}
                            </div>
                        </div>
                        {{/each}}
                        {{else}}
                        <div class="hex-no-custom-tiles">
                            <p><i class="fas fa-map-marker-alt"></i></p>
                            <p>No symbol tiles found</p>
                        </div>
                        {{/if}}
                    </div>
                </div>

                <!-- Usage hints -->
                <div class="tray-footer-message">
                    {{#if (eq activeTileTab 'symbols')}}
                    Drag to paint · Shift+Drag to erase · Right-click to cycle · +/- to resize
                    {{else}}
                    Drag to paint · Shift+Drag to erase
                    {{/if}}
                </div>
            </div>
            {{/if}}

            <!-- DUNGEONS TAB (GM or Player with GM online) -->
            {{#if (or isGM canPlayerPaint)}}
            <div class="tray-view-content dungeons-view {{#unless (eq viewMode 'dungeons')}}hidden{{/unless}}"
                style="overflow-y: hidden; display: flex; flex-direction: column;">

                <!-- Mode Tabs -->
                <div class="dungeon-mode-tabs">
                    <button class="dungeon-mode-tab {{#if (eq dungeonMode 'tiles')}}active{{/if}}"
                        data-dungeon-mode="tiles">
                        <i class="fas fa-vector-square"></i> Rooms
                    </button>
                    <button class="dungeon-mode-tab {{#if (eq dungeonMode 'intwalls')}}active{{/if}}"
                        data-dungeon-mode="intwalls">
                        <i class="fas fa-border-style"></i> Int. Walls
                    </button>
                    <button class="dungeon-mode-tab {{#if (eq dungeonMode 'doors')}}active{{/if}}"
                        data-dungeon-mode="doors">
                        <i class="fas fa-door-open"></i> Doors
                    </button>
                </div>

                <!-- Options (GM only) -->
                {{#if isGM}}
                {{#unless (eq dungeonMode 'intwalls')}}
                <div class="dungeon-bg-select">
                    <label>
                        <i class="fas fa-image"></i>
                        <select class="dungeon-background-select">
                            {{#each backgroundOptions}}
                            <option value="{{this.value}}" {{#if this.active}}selected{{/if}}>{{this.label}}</option>
                            {{/each}}
                        </select>
                    </label>
                </div>
                {{/unless}}
                <div class="dungeon-options-section">
                    <label class="dungeon-option-toggle">
                        <input type="checkbox" class="dungeon-no-walls-checkbox" {{#if noFoundryWalls}}checked{{/if}} />
                        <span><i class="fas fa-border-none"></i> No Foundry Walls</span>
                    </label>
                    <label class="dungeon-option-toggle">
                        <input type="checkbox" class="dungeon-wall-shadows-checkbox" {{#if
                            wallShadows}}checked{{/if}} />
                        <span><i class="fas fa-adjust"></i> Wall Shadows</span>
                    </label>
                </div>

                {{#unless (eq dungeonMode 'intwalls')}}
                <!-- Flatten Level Buttons -->
                <div class="dungeon-flatten-buttons">
                    <button class="dungeon-flatten-level-btn">
                        <i class="fas fa-layer-group"></i> Flatten Level
                    </button>
                    <button class="dungeon-unflatten-level-btn">
                        <i class="fas fa-layer-group" style="transform:scaleY(-1)"></i> Unflatten Level
                    </button>
                </div>

                <!-- Generator Button -->
                <label class="dungeon-option-toggle dungeon-generator-toggle">
                    <span><i class="fas fa-magic"></i> Generator</span>
                </label>

                <!-- Generator Panel (collapsible) -->
                {{#if generatorExpanded}}
                <div class="dungeon-generator-panel">
                    <div class="dungeon-generator-header">
                        <span>Procedural Dungeon</span>
                        <button class="dungeon-generator-close"><i class="fas fa-times"></i></button>
                    </div>

                    <div class="dgen-section">
                        <div class="dgen-section-title">Layout</div>
                        <div class="dgen-row">
                            <label>Rooms</label>
                            <input type="range" class="dgen-rooms" min="3" max="20" value="{{generatorSettings.rooms}}"
                                step="1">
                            <span class="dgen-value">{{generatorSettings.rooms}}</span>
                        </div>
                        <div class="dgen-row">
                            <label>Density</label>
                            <input type="range" class="dgen-density" min="0" max="1"
                                value="{{generatorSettings.density}}" step="0.1">
                            <span class="dgen-value">{{generatorSettings.density}}</span>
                        </div>
                        <div class="dgen-row">
                            <label>Branching</label>
                            <input type="range" class="dgen-branching" min="0" max="1"
                                value="{{generatorSettings.branching}}" step="0.1">
                            <span class="dgen-value">{{generatorSettings.branching}}</span>
                        </div>
                        <div class="dgen-row">
                            <label>Room Size</label>
                            <input type="range" class="dgen-roomsize" min="0" max="1"
                                value="{{generatorSettings.roomSize}}" step="0.1">
                            <span class="dgen-value">{{generatorSettings.roomSize}}</span>
                        </div>
                        <div class="dgen-row dgen-checkbox-row">
                            <label>Symmetry</label>
                            <input type="checkbox" class="dgen-symmetry" {{#if
                                generatorSettings.symmetry}}checked{{/if}}>
                        </div>
                        <div class="dgen-row">
                            <label>Stairs Up</label>
                            <input type="range" class="dgen-stairs" min="0" max="20"
                                value="{{generatorSettings.stairs}}" step="1">
                            <span class="dgen-value">{{generatorSettings.stairs}}</span>
                        </div>
                        <div class="dgen-row">
                            <label>Stairs Down</label>
                            <input type="range" class="dgen-stairsdown" min="0" max="20"
                                value="{{generatorSettings.stairsDown}}" step="1">
                            <span class="dgen-value">{{generatorSettings.stairsDown}}</span>
                        </div>
                        <div class="dgen-row">
                            <label>Clutter</label>
                            <input type="range" class="dgen-clutter" min="0" max="10"
                                value="{{generatorSettings.clutter}}" step="1">
                            <span class="dgen-value">{{generatorSettings.clutter}}</span>
                        </div>
                    </div>

                    <div class="dgen-section">
                        <div class="dgen-section-title">Walls</div>
                        <div class="dgen-row dgen-checkbox-row">
                            <label>Textured</label>
                            <input type="checkbox" class="dgen-textured" {{#if
                                generatorSettings.textured}}checked{{/if}}>
                        </div>
                        <div class="dgen-row dgen-checkbox-row">
                            <label>Wall Shadows</label>
                            <input type="checkbox" class="dgen-wall-shadows" {{#if
                                generatorSettings.wallShadows}}checked{{/if}}>
                        </div>
                        <div class="dgen-row dgen-color-row">
                            <label>Color</label>
                            <input type="color" class="dgen-wall-color" value="{{generatorSettings.wallColor}}">
                        </div>
                        <div class="dgen-row dgen-slider-row">
                            <label>Thickness</label>
                            <input type="range" class="dgen-thickness" min="5" max="40"
                                value="{{generatorSettings.thickness}}" step="5">
                            <span class="dgen-value">{{generatorSettings.thickness}}</span>
                        </div>
                    </div>

                    <div class="dgen-section dgen-section-inline">
                        <div class="dgen-section-title">Seed</div>
                        <div class="dgen-seed-row">
                            <input type="text" class="dgen-seed" value="{{generatorSeed}}">
                            <button class="dgen-seed-refresh" title="Randomize"><i class="fas fa-sync-alt"></i></button>
                        </div>
                    </div>

                    <button class="dgen-apply">
                        <i class="fas fa-wand-magic-sparkles"></i> Generate
                    </button>
                </div>
                {{/if}}
                {{/unless}}

                {{else}}
                <!-- Player info -->
                <div class="dungeon-player-info">
                    <i class="fas fa-satellite-dish"></i> Painting via GM connection
                </div>
                {{/if}}

                <!-- Tiles Grid (shows floor tiles or door tiles depending on mode) -->
                <div class="dungeon-tile-scroll"
                    style="flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.2) rgba(0,0,0,0.1);">

                    {{#if (eq dungeonMode 'intwalls')}}
                    <!-- Interior Wall Tiles -->
                    <div class="dungeon-section-label"><i class="fas fa-border-style"></i> Interior Wall Tiles</div>
                    {{#if hasWallTiles}}
                    <div class="dungeon-tile-grid dungeon-intwall-grid">
                        {{#each intWallTiles}}
                        <div class="dungeon-tile-thumb dungeon-intwall-thumb {{#if this.active}}active{{/if}}"
                            data-dungeon-intwall="{{this.path}}" title="{{this.label}}">
                            <img src="{{this.src}}" alt="{{this.label}}" loading="lazy" />
                        </div>
                        {{/each}}
                    </div>
                    {{else}}
                    <div class="dungeon-no-tiles dungeon-no-walls">
                        <p><i class="fas fa-border-style"></i></p>
                        <p>No wall tiles found</p>
                        <p class="dungeon-hint">Add tiles to:<br><code>assets/Dungeon/wall_tiles/</code></p>
                    </div>
                    {{/if}}

                    <!-- Interior Door Tiles -->
                    <div class="dungeon-section-label"><i class="fas fa-door-open"></i> Doors</div>
                    {{#if hasIntDoorTiles}}
                    <div class="dungeon-tile-grid dungeon-door-grid">
                        {{#each intDoorTiles}}
                        <div class="dungeon-tile-thumb dungeon-intdoor-thumb {{#if this.active}}active{{/if}}"
                            data-dungeon-intdoor="{{this.path}}" title="{{this.label}}">
                            <img src="{{this.src}}" alt="{{this.label}}" loading="lazy" />
                            <span class="dungeon-tile-label">{{this.label}}</span>
                        </div>
                        {{/each}}
                    </div>
                    {{else}}
                    <div class="dungeon-no-tiles">
                        <p><i class="fas fa-door-open"></i></p>
                        <p>No door tiles found</p>
                        <p class="dungeon-hint">Add tiles to:<br><code>assets/Dungeon/door_tiles/</code></p>
                    </div>
                    {{/if}}
                    {{else if (eq dungeonMode 'tiles')}}
                    <!-- Floor Tiles -->
                    <div class="dungeon-section-label"><i class="fas fa-th"></i> Floor Tiles</div>
                    {{#if hasFloorTiles}}
                    <div class="dungeon-tile-grid">
                        {{#each floorTiles}}
                        <div class="dungeon-tile-thumb {{#if this.active}}active{{/if}}"
                            data-dungeon-tile="{{this.path}}" title="{{this.label}}">
                            <img src="{{this.src}}" alt="{{this.label}}" loading="lazy" />
                        </div>
                        {{/each}}
                    </div>
                    {{else}}
                    <div class="dungeon-no-tiles">
                        <p><i class="fas fa-dungeon"></i></p>
                        <p>No floor tiles found</p>
                        <p class="dungeon-hint">Add tiles to:<br><code>assets/Dungeon/floor_tiles/</code></p>
                    </div>
                    {{/if}}

                    <!-- Wall Tiles -->
                    <div class="dungeon-section-label"><i class="fas fa-border-all"></i> Wall Tiles</div>
                    {{#if hasWallTiles}}
                    <div class="dungeon-tile-grid dungeon-wall-grid">
                        {{#each wallTiles}}
                        <div class="dungeon-tile-thumb dungeon-wall-thumb {{#if this.active}}active{{/if}}"
                            data-dungeon-wall="{{this.path}}" title="{{this.label}}">
                            <img src="{{this.src}}" alt="{{this.label}}" loading="lazy" />
                        </div>
                        {{/each}}
                    </div>
                    {{else}}
                    <div class="dungeon-no-tiles dungeon-no-walls">
                        <p><i class="fas fa-border-all"></i></p>
                        <p>No wall tiles found</p>
                        <p class="dungeon-hint">Add tiles to:<br><code>assets/Dungeon/wall_tiles/</code></p>
                    </div>
                    {{/if}}
                    {{else}}
                    <!-- Door Tiles -->
                    {{#if hasDoorTiles}}
                    <div class="dungeon-tile-grid dungeon-door-grid">
                        {{#each doorTiles}}
                        <div class="dungeon-tile-thumb dungeon-door-thumb {{#if this.active}}active{{/if}}"
                            data-dungeon-door="{{this.path}}" title="{{this.label}}">
                            <img src="{{this.src}}" alt="{{this.label}}" loading="lazy" />
                            <span class="dungeon-tile-label">{{this.label}}</span>
                        </div>
                        {{/each}}
                    </div>
                    {{else}}
                    <div class="dungeon-no-tiles">
                        <p><i class="fas fa-door-open"></i></p>
                        <p>No door tiles found</p>
                        <p class="dungeon-hint">Add tiles to:<br><code>assets/Dungeon/door_tiles/</code></p>
                    </div>
                    {{/if}}
                    {{/if}}
                </div>

                <!-- Usage hints -->
                <div class="tray-footer-message dungeon-hints">
                    {{#if (eq dungeonMode 'tiles')}}
                    <div class="dungeon-hint-row">
                        <i class="fas fa-expand-arrows-alt"></i> <span>Drag</span> to fill rectangle
                    </div>
                    <div class="dungeon-hint-row">
                        <i class="fas fa-eraser"></i> <span>Shift+Drag</span> to delete
                    </div>
                    {{else if (eq dungeonMode 'intwalls')}}
                    <div class="dungeon-hint-row">
                        <i class="fas fa-vector-square"></i> <span>Drag</span> wall tile to draw
                    </div>
                    <div class="dungeon-hint-row">
                        <i class="fas fa-door-open"></i> <span>Click</span> int. wall to insert door
                    </div>
                    <div class="dungeon-hint-row">
                        <i class="fas fa-eraser"></i> <span>Shift+Click</span> to remove door
                    </div>
                    {{else}}
                    <div class="dungeon-hint-row">
                        <i class="fas fa-mouse-pointer"></i> <span>Click</span> on edge to add door
                    </div>
                    <div class="dungeon-hint-row">
                        <i class="fas fa-eraser"></i> <span>Shift+Click</span> to remove door
                    </div>
                    {{/if}}
                    <div class="dungeon-hint-row">
                        <i class="fas fa-sync-alt"></i> <span>Ctrl</span> to switch mode
                    </div>
                    <div class="dungeon-hint-info">
                        Walls auto-rebuild on release
                    </div>
                </div>

            </div>
            {{/if}}

            <!-- DECOR TAB (GM ONLY) -->
            {{#if isGM}}
            <div class="tray-view-content decor-view {{#unless (eq viewMode 'decor')}}hidden{{/unless}}"
                style="overflow-y: hidden; display: flex; flex-direction: column;">

                <!-- Search -->
                <div class="hex-search-section">
                    <input type="text" class="decor-search-input" placeholder="Search decor tiles..."
                        value="{{decorSearchFilter}}" />
                </div>

                <!-- POI info -->
                <div class="hex-custom-size-section poi-info-section">
                    <div class="hex-custom-folder-hint">
                        <i class="fas fa-info-circle"></i> Decor paint on top · Scale: {{poiScalePercent}}%
                    </div>
                    <div class="decor-fields-row"
                        style="display:flex; gap:8px; align-items:center; margin-top:4px; font-size:11px;">
                        <label style="display:flex; align-items:center; gap:3px; color:#aaa;">
                            Elev <input type="number" class="decor-elevation-input" value="{{decorElevation}}"
                                step="0.1"
                                style="width:50px; padding:1px 4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.15); border-radius:3px; color:#ddd; font-size:11px;" />
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; color:#aaa;">
                            Sort <input type="number" class="decor-sort-input" value="{{decorSort}}" step="1"
                                style="width:50px; padding:1px 4px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.15); border-radius:3px; color:#ddd; font-size:11px;" />
                        </label>
                    </div>
                </div>

                <!-- Decor folder grid -->
                <div class="hex-tile-scroll decor-tile-scroll"
                    style="flex:1; overflow-y:auto; scrollbar-width:thin; scrollbar-color:rgba(255,255,255,0.2) rgba(0,0,0,0.1);">
                    {{#if decorFolders.length}}
                    {{#each decorFolders}}
                    <div class="hex-symbol-folder" data-folder="{{this.folder}}">
                        <div class="decor-folder-header hex-symbol-folder-header {{#if this.collapsed}}collapsed{{/if}}"
                            data-action="toggle-decor-folder" data-folder="{{this.folder}}">
                            <i
                                class="fas {{#if this.collapsed}}fa-caret-right{{else}}fa-caret-down{{/if}} hex-folder-chevron"></i>
                            <i
                                class="fas {{#if this.collapsed}}fa-folder{{else}}fa-folder-open{{/if}} hex-folder-icon"></i>
                            <span class="hex-folder-name">{{this.label}}</span>
                            <span class="hex-folder-count">({{this.tiles.length}})</span>
                        </div>
                        <div class="hex-tile-grid hex-symbol-folder-content {{#if this.collapsed}}hidden{{/if}}">
                            {{#each this.tiles}}
                            <div class="hex-tile-thumb decor-tile-thumb {{#if this.active}}active{{/if}}"
                                data-tile="{{this.path}}"
                                title="{{this.label}}{{#if this.category}} ({{this.category}}){{/if}}">
                                <img src="{{this.src}}" alt="{{this.label}}" />
                                <span class="hex-tile-label">{{this.label}}</span>
                            </div>
                            {{/each}}
                        </div>
                    </div>
                    {{/each}}
                    {{else}}
                    <div class="hex-no-custom-tiles">
                        <p><i class="fas fa-couch"></i></p>
                        <p>No decor tiles found</p>
                    </div>
                    {{/if}}
                </div>

                <!-- Footer hint -->
                <div class="tray-footer-message">
                    Click to place · +/- to resize · Right-click to cycle
                </div>
            </div>
            {{/if}}
        </div>
    </div>