<div class="sdx-tray {{#if isExpanded}}expanded{{/if}}" data-position="left">

    <!-- TRAY HANDLE -->
    <div class="tray-handle">
        <div class="tray-handle-content-container">

            <button class="tray-handle-button-toggle" title="Toggle Tray">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
            <button class="tray-handle-button-viewcycle" title="Toggle View Mode">
                <i class="fas {{#if (eq viewMode 'party')}}fa-users{{else}}fa-user{{/if}}"></i>
            </button>

            <!-- GM TOOLS -->
            {{#if isGM}}
            <button class="tray-handle-button-tool" data-action="leader" title="Choose Party Leader">
                <i class="fa-solid fa-crown"></i>
            </button>
            <button class="tray-handle-button-tool" data-action="marching" title="Marching Mode">
                <i class="fa-solid fa-person-walking"></i>
            </button>
            <button class="tray-handle-button-tool" data-action="formation" title="Formation Spawner">
                <i class="fa-solid fa-users-viewfinder"></i>
            </button>
            <button class="tray-handle-button-tool" data-action="add-pin" title="Add Pin">
                <i class="fa-solid fa-map-pin"></i>
            </button>
            <button class="tray-handle-button-tool" data-action="pin-list" title="Pin List">
                <i class="fa-solid fa-list"></i>
            </button>

            <button class="tray-handle-button-tool" data-action="light-tracker" title="Light Source Tracker">
                <i class="fa-solid fa-fire"></i>
            </button>



            {{#if showTomOverlays}}
            <button class="tray-handle-button-tool tom-overlay-manager-btn" data-action="tom-overlay-manager"
                title="Video Overlays">
                <i class="fa-solid fa-film"></i>
            </button>
            {{/if}}
            {{/if}}
            <button class="tray-handle-button-tool" data-action="carousing" title="Carousing">
                <i class="fa-solid fa-beer"></i>
            </button>
            <button class="tray-handle-button-tool" data-action="sdx-drawing" title="Drawing Tools">
                <i class="fa-solid fa-pencil"></i>
            </button>
            {{#if isGM}}
            <button class="tray-handle-button-tool" data-action="sdx-roller" title="SDX Roller">
                <i class="fa-solid fa-dice"></i>
            </button>
            {{/if}}

            <div class="tray-handle-content-wrapper">
                {{#if (eq viewMode 'player')}}
                <!-- PLAYER HANDLE -->
                {{#if actor}}
                <div class="handle-info-container">
                    <span class="handle-info-title">{{default actorDisplayName actor.name}}</span>
                </div>
                <span class="tray-handle-separator spacer"></span>
                <div class="handle-partymembers">
                    <div class="handle-character-icon" data-actor-id="{{actor.id}}">
                        <img src="{{actor.img}}" alt="{{actor.name}}" />
                    </div>
                    {{#if showHealthBars}}
                    <div class="handle-healthbar" title="{{actorHP.value}}/{{actorHP.max}} HP">
                        <div class="handle-healthbar-fill {{actorHealthbarStatus}}"
                            style="height: {{actorHP.percent}}%"></div>
                        <span class="handle-healthbar-value">{{actorHP.value}}</span>
                        <span class="handle-healthbar-icon {{actorHealthbarStatus}}"><i
                                class="fa-solid fa-skull"></i></span>
                    </div>
                    {{/if}}
                </div>

                {{#if activeEffects}}
                <span class="tray-handle-separator spacer"></span>
                <div class="tray-handle-effects">
                    {{#each activeEffects}}
                    <div class="tray-effect-icon" data-effect-id="{{this.id}}" data-tooltip="{{this.name}}">
                        <img src="{{this.img}}" alt="{{this.name}}" />
                    </div>
                    {{/each}}
                    <div class="tray-effect-add" data-action="add-condition" data-tooltip="Add Condition">
                        <i class="fas fa-plus"></i>
                    </div>
                </div>
                {{else}}
                <span class="tray-handle-separator spacer"></span>
                <div class="tray-handle-effects">
                    <div class="tray-effect-add" data-action="add-condition" data-tooltip="Add Condition">
                        <i class="fas fa-plus"></i>
                    </div>
                </div>
                {{/if}}

                <span class="tray-handle-separator line-ridge-thin"></span>
                {{else}}
                <div class="handle-info-container">
                    <span class="handle-info-title">Select a Character</span>
                </div>
                <span class="tray-handle-separator spacer"></span>
                {{/if}}
                {{else}}
                <!-- PARTY HANDLE -->
                <div class="handle-info-container">
                    <span class="handle-info-title">{{#if partyName}}{{partyName}}{{else}}Party{{/if}}</span>
                </div>
                <span class="tray-handle-separator spacer"></span>

                {{#if actor}}
                <div class="handle-partymembers">
                    <div class="handle-character-icon" data-actor-id="{{actor.id}}">
                        <img src="{{actor.img}}" alt="{{actor.name}}" />
                    </div>
                    {{#if showHealthBars}}
                    <div class="handle-healthbar" title="{{actorHP.value}}/{{actorHP.max}} HP">
                        <div class="handle-healthbar-fill {{actorHealthbarStatus}}"
                            style="height: {{actorHP.percent}}%"></div>
                        <span class="handle-healthbar-value">{{actorHP.value}}</span>
                        <span class="handle-healthbar-icon {{actorHealthbarStatus}}"><i
                                class="fa-solid fa-skull"></i></span>
                    </div>
                    {{/if}}
                </div>
                <span class="tray-handle-separator line-ridge-thin"></span>
                {{/if}}

                {{#if otherPartyMembers}}
                {{#each otherPartyMembers as |member|}}
                {{#unless @first}}<span class="tray-handle-separator line-dotted-thin"></span>{{/unless}}
                <div class="handle-partymembers">
                    <div class="handle-partymember-icon {{#if member.isOwner}}clickable{{/if}}" {{#if
                        member.isOwner}}data-tooltip="Switch to {{member.name}}" {{/if}}
                        data-actor-id="{{member.actor.id}}">
                        <img src="{{member.img}}" alt="{{member.name}}" />
                    </div>
                    {{#if ../showHealthBars}}
                    <div class="handle-healthbar party" title="{{member.hp.value}}/{{member.hp.max}} HP">
                        <div class="handle-healthbar-fill {{member.healthbarStatus}}"
                            style="height: {{member.hp.percent}}%"></div>
                        <span class="handle-healthbar-value {{member.healthbarStatus}}">{{member.hp.value}}</span>
                        <span class="handle-healthbar-icon {{member.healthbarStatus}}"><i
                                class="fa-solid fa-skull"></i></span>
                    </div>
                    {{/if}}
                </div>
                {{/each}}
                <span class="tray-handle-separator line-ridge-thin"></span>
                {{/if}}
                {{/if}}
            </div>
        </div>
        <div class="tray-handle-fade-bottom"></div>
    </div>

    <!-- TRAY CONTENT -->
    <div class="tray-content">

        <!-- GM TOOLS -->


        <!-- TRAY TABS -->
        <div class="tray-view-tabs">
            {{#if isGM}}
            <button class="tray-tab-button {{#if (eq viewMode 'scenes')}}active{{/if}}" data-view="scenes"
                title="Scenes View">
                <i class="fa-solid fa-images"></i> Scenes
            </button>
            {{else}}
            <button class="tray-tab-button {{#if (eq viewMode 'player')}}active{{/if}}" data-view="player"
                title="Player View">
                <i class="fa-solid fa-user"></i> Token
            </button>
            {{/if}}
            {{#if showTabParty}}
            <button class="tray-tab-button {{#if (eq viewMode 'party')}}active{{/if}}" data-view="party"
                title="Party View">
                <i class="fa-solid fa-users"></i> Party
            </button>
            {{/if}}
            {{#if isGM}}
            <button class="tray-tab-button {{#if (eq viewMode 'pins')}}active{{/if}}" data-view="pins"
                title="Journal Pins">
                <i class="fa-solid fa-map-pin"></i> Pins
            </button>
            {{/if}}
            <button class="tray-tab-button {{#if (eq viewMode 'notes')}}active{{/if}}" data-view="notes"
                title="Placeable Notes">
                <i class="fa-solid fa-sticky-note"></i> Notes
            </button>
            {{#if isGM}}
            <button class="tray-tab-button {{#if (eq viewMode 'hexes')}}active{{/if}}" data-view="hexes"
                title="Hex Painter">
                <i class="fas fa-border-all"></i> Hexes
            </button>
            {{/if}}
        </div>

        <!-- PANELS -->
        <div class="tray-panel-wrapper">

            <!-- Selection Info - Only shown when multiple tokens are selected -->
            {{#if showSelectionBox}}
            <div class="tray-selection-wrapper">
                <div class="tray-selection-count">{{selectionCount}} tokens selected</div>
                <div class="tray-selection-actions">
                    <button class="tray-selection-button button-clear"
                        data-tooltip="Clear all selections">Clear</button>
                </div>
            </div>
            {{/if}}

            <!-- PLAYER TAB -->
            <div class="tray-view-content player-view {{#unless (eq viewMode 'player')}}hidden{{/unless}}">
                {{#if actor}}
                <!-- CHARACTER PANEL -->
                <div class="panel-container" data-panel="character" data-clickable="true">
                    <div class="character-panel">
                        <div class="character-portrait" style="background-image: url('{{actor.img}}')">
                            {{#if actorHP}}
                            <div class="health-overlay" style="height: {{healthOverlayHeight actorHP}}"></div>
                            {{#if (eq actorHP.value 0)}}
                            <i class="fa-solid fa-skull death-skull"></i>
                            {{/if}}
                            {{/if}}
                        </div>
                        <div class="character-info">
                            <div class="character-name">{{actor.name}}</div>
                            <div class="character-details">
                                {{#if actor.system.level.value}}
                                <span class="character-level">Level {{actor.system.level.value}}</span>
                                {{/if}}
                            </div>
                            {{#if actorHP}}
                            <div class="character-hp-bar">
                                <div class="hp-current">
                                    <span class="hp-value">{{actorHP.value}}</span>
                                </div>
                                <div class="hp-fill {{actorHealthbarStatus}}" style="width: {{actorHP.percent}}%"></div>
                                <div class="hp-max">
                                    <span class="hp-value">{{actorHP.max}}</span>
                                </div>
                            </div>
                            {{/if}}
                        </div>
                    </div>
                </div>
                {{else}}
                <div class="no-character-message">
                    <p>NO TOKEN SELECTED OR OWNED</p>
                    <p>Select an owned token to get started.</p>
                </div>
                {{/if}}
            </div>

            <!-- SCENES TAB (GM ONLY) -->
            {{#if isGM}}
            <div class="tray-view-content scenes-view {{#unless (eq viewMode 'scenes')}}hidden{{/unless}}"
                style="overflow-y: hidden; display: flex; flex-direction: column;">

                <!-- Create/Stop Header -->
                <div class="scenes-header" style="flex: 0 0 auto; padding: 10px;">
                    <button class="tray-btn-full" data-action="create-scene">
                        <i class="fas fa-plus"></i> Create New Scene
                    </button>
                    <button class="tray-btn-full folder-create-btn" data-action="create-folder">
                        <i class="fas fa-folder-plus"></i> Create New Folder
                    </button>
                    {{#if tomActiveSceneId}}
                    <button class="tray-btn-full danger mt-2" data-action="stop-broadcast">
                        <i class="fas fa-stop"></i> Stop Broadcasting
                    </button>
                    {{/if}}
                </div>

                <!-- Scenes List -->
                <div class="scenes-list-scroll"
                    style="flex: 1; overflow-y: auto; scrollbar-width: thin; padding: 0 10px 10px 10px;">

                    {{!-- Render Folders --}}
                    {{#each tomFolders}}
                    <div class="scene-folder" data-folder-id="{{this.id}}">
                        <div class="scene-folder-header {{#if this.collapsed}}collapsed{{/if}}"
                            data-action="toggle-folder" data-folder-id="{{this.id}}">
                            <i
                                class="fas {{#if this.collapsed}}fa-caret-right{{else}}fa-caret-down{{/if}} scene-folder-chevron"></i>
                            <i
                                class="fas {{#if this.collapsed}}fa-folder{{else}}fa-folder-open{{/if}} scene-folder-icon"></i>
                            <span class="scene-folder-name">{{this.name}}</span>
                            <span class="scene-folder-count">({{this.scenes.length}})</span>
                            <div class="scene-folder-actions">
                                <button class="scene-action-btn" data-action="rename-folder"
                                    data-folder-id="{{this.id}}" data-folder-name="{{this.name}}" title="Rename Folder">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button class="scene-action-btn danger" data-action="delete-folder"
                                    data-folder-id="{{this.id}}" data-folder-name="{{this.name}}" title="Delete Folder">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="scene-folder-content {{#if this.collapsed}}hidden{{/if}}"
                            data-folder-id="{{this.id}}">
                            {{#if this.scenes.length}}
                            {{#each this.scenes}}
                            <div class="scene-card {{#if (eq this.id ../../tomActiveSceneId)}}active{{/if}}"
                                data-scene-id="{{this.id}}" draggable="true">
                                <div class="scene-card-activate" title="Click to Broadcast">
                                    <div class="scene-card-thumb">
                                        {{#if this.isVideo}}
                                        <video src="{{this.background}}" muted loop preload="metadata"
                                            class="scene-thumb-video"></video>
                                        {{else}}
                                        <div class="scene-thumb-image"
                                            style="background-image: url('{{this.background}}')">
                                        </div>
                                        {{/if}}
                                        {{#if (eq this.id ../../tomActiveSceneId)}}
                                        <div class="scene-playing-overlay">
                                            <i class="fas fa-play"></i>
                                        </div>
                                        {{/if}}
                                    </div>
                                    <div class="scene-card-info">
                                        <div class="scene-name">{{this.name}}</div>
                                        {{#if this.isArena}}
                                        <div class="scene-tag arena">Arena</div>
                                        {{/if}}
                                    </div>
                                </div>
                                <div class="scene-card-actions">
                                    <button class="scene-action-btn" data-action="edit-scene" title="Edit Scene">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                    <button class="scene-action-btn danger" data-action="delete-scene"
                                        title="Delete Scene">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {{/each}}
                            {{else}}
                            <div class="scene-folder-empty">Drag scenes here</div>
                            {{/if}}
                        </div>
                    </div>
                    {{/each}}

                    {{!-- Uncategorized Scenes (no folderId) --}}
                    {{#if tomFolders.length}}
                    <div class="scene-uncat-header">Uncategorized</div>
                    {{/if}}
                    <div class="scene-uncat-container" data-folder-id="">
                        {{#each tomScenes}}
                        {{#unless this.folderId}}
                        <div class="scene-card {{#if (eq this.id ../tomActiveSceneId)}}active{{/if}}"
                            data-scene-id="{{this.id}}" draggable="true">
                            <div class="scene-card-activate" title="Click to Broadcast">
                                <div class="scene-card-thumb">
                                    {{#if this.isVideo}}
                                    <video src="{{this.background}}" muted loop preload="metadata"
                                        class="scene-thumb-video"></video>
                                    {{else}}
                                    <div class="scene-thumb-image" style="background-image: url('{{this.background}}')">
                                    </div>
                                    {{/if}}
                                    {{#if (eq this.id ../tomActiveSceneId)}}
                                    <div class="scene-playing-overlay">
                                        <i class="fas fa-play"></i>
                                    </div>
                                    {{/if}}
                                </div>
                                <div class="scene-card-info">
                                    <div class="scene-name">{{this.name}}</div>
                                    {{#if this.isArena}}
                                    <div class="scene-tag arena">Arena</div>
                                    {{/if}}
                                </div>
                            </div>
                            <div class="scene-card-actions">
                                <button class="scene-action-btn" data-action="edit-scene" title="Edit Scene">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button class="scene-action-btn danger" data-action="delete-scene" title="Delete Scene">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {{/unless}}
                        {{/each}}
                    </div>

                    {{!-- Empty state --}}
                    {{#unless tomScenes.length}}
                    {{#unless tomFolders.length}}
                    <div class="no-content-message">
                        <p>No Scenes Created</p>
                    </div>
                    {{/unless}}
                    {{/unless}}
                </div>
            </div>
            {{/if}}

            <!-- PARTY TAB -->
            <div class="tray-view-content party-view {{#unless (eq viewMode 'party')}}hidden{{/unless}}">

                <!-- Party Toolbar -->
                <div class="tray-tools-toolbar">
                    {{#if isGM}}
                    <button class="tray-tools-button" data-action="select-party">
                        <i class="fa-solid fa-users-viewfinder"></i> Select Party
                    </button>
                    {{else}}
                    <button class="tray-tools-button" data-action="select-party">
                        <i class="fa-solid fa-users-viewfinder"></i> Select Owned
                    </button>
                    {{/if}}
                </div>

                <!-- PARTY HEALTH -->
                <div class="party-health-card">
                    <div class="party-health-card-info">
                        <div class="party-health-card-title">Party Health</div>
                        <div class="party-health-card-details">
                            <div class="party-hp-bar party-health-card-hp-bar">
                                <div class="hp-current">
                                    <span class="hp-value">{{partyRemainingHP}}</span>
                                </div>
                                <div class="hp-fill {{partyHealthbarStatus}}"
                                    style="width: {{multiply (divide partyRemainingHP partyTotalHP) 100}}%"></div>
                                <div class="hp-max">
                                    <span class="hp-value">{{partyTotalHP}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PARTY CHARACTERS -->
                {{#each partyTokens as |member|}}
                <div class="party-card {{#if member.isOwner}}party-card-clickable{{/if}} {{#if member.isSelected}}party-card-selected{{/if}}"
                    data-token-id="{{member.id}}">
                    <div class="party-card-image party-card-clickable" style="background-image: url('{{member.img}}')"
                        title="Click to select token">
                        {{#if member.hp}}
                        <div class="health-overlay" style="height: {{healthOverlayHeight member.hp}}"></div>
                        {{#if (eq member.hp.value 0)}}
                        <i class="fa-solid fa-skull death-skull"></i>
                        {{/if}}
                        {{/if}}
                    </div>
                    <div class="party-card-info">
                        <div class="party-card-name">{{member.name}}</div>
                        <div class="party-card-details">
                            {{#if member.hp}}
                            <div class="party-hp-bar">
                                <div class="hp-current">
                                    <span class="hp-value">{{member.hp.value}}</span>
                                </div>
                                <div class="hp-fill {{member.healthbarStatus}}" style="width: {{member.hp.percent}}%">
                                </div>
                                <div class="hp-max">
                                    <span class="hp-value">{{member.hp.max}}</span>
                                </div>
                            </div>
                            {{/if}}
                        </div>
                    </div>
                    <div class="party-card-actions">
                        {{#if member.isOwner}}
                        <i class="fa-solid fa-feather-alt open-sheet" title="Open Character Sheet"></i>
                        {{/if}}
                    </div>
                </div>
                {{else}}
                <div class="no-party-message">
                    <p>- No Party Tokens to Display -</p>
                    <p>Add tokens to the scene to get started</p>
                </div>
                {{/each}}

                <!-- MONSTER AND NPC CHARACTERS -->
                {{#if isGM}}
                {{#if npcTokens.length}}
                <div class="section-divider">
                    <span class="divider-text">MONSTERS & NPCs</span>
                </div>

                {{#each npcTokens as |npc|}}
                <div class="party-card party-npc-card {{#if npc.isSelected}}party-card-selected{{/if}}"
                    data-token-id="{{npc.id}}">
                    <div class="party-card-image party-card-clickable" style="background-image: url('{{npc.img}}')"
                        title="Click to select token">
                        {{#if npc.hp}}
                        <div class="health-overlay" style="height: {{healthOverlayHeight npc.hp}}"></div>
                        {{#if (eq npc.hp.value 0)}}
                        <i class="fa-solid fa-skull death-skull"></i>
                        {{/if}}
                        {{/if}}
                    </div>
                    <div class="party-card-info">
                        <div class="party-card-name">{{npc.name}}</div>
                        <div class="party-card-details">
                            {{#if npc.hp}}
                            <div class="party-hp-bar">
                                <div class="hp-current">
                                    <span class="hp-value">{{npc.hp.value}}</span>
                                </div>
                                <div class="hp-fill {{npc.healthbarStatus}}" style="width: {{npc.hp.percent}}%"></div>
                                <div class="hp-max">
                                    <span class="hp-value">{{npc.hp.max}}</span>
                                </div>
                            </div>
                            {{/if}}
                        </div>
                    </div>
                    <div class="party-card-actions">
                        <i class="fa-solid fa-feather-alt open-sheet" title="Open Character Sheet"></i>
                    </div>
                </div>
                {{/each}}
                {{/if}}
                {{/if}}
            </div>

            <!-- PINS TAB -->
            <div class="tray-view-content pins-view {{#unless (eq viewMode 'pins')}}hidden{{/unless}}"
                style="overflow-y: hidden; display: flex; flex-direction: column;">

                <!-- Search Bar -->
                <div class="pin-search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" class="pin-search-input" placeholder="Search pins..." value="{{pinSearchTerm}}">
                </div>

                <!-- Pin List Content -->
                <div class="pin-list-scroll-container"
                    style="flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(255, 255, 255, 0.2) rgba(0, 0, 0, 0.1);">
                    {{#if pins.length}}
                    <ul class="sdx-pin-list">
                        {{#each pins}}
                        <li class="pin-entry flexrow" data-id="{{this.id}}" data-x="{{this.x}}" data-y="{{this.y}}"
                            style="align-items: stretch; padding: 0;">
                            <div
                                style="flex: 0 0 50px; width: 50px; display: flex; align-items: center; justify-content: center; border-right: 1px solid #85733f;">
                                <div class="pin-icon"
                                    style="display: flex; justify-content: center; align-items: center; background-color: {{this.backgroundColor}}; border: 2px solid {{this.borderColor}}; border-radius: {{this.borderRadius}}; width: 32px; height: 32px; box-shadow: 0 0 4px rgba(0,0,0,0.5);">
                                    {{#if (eq this.displayType "image")}}
                                    <img src="{{this.displayContent}}"
                                        style="display: block; width: 20px; height: 20px; object-fit: contain;"
                                        alt="Icon" />
                                    {{else if (eq this.displayType "icon")}}
                                    <i class="{{this.displayClass}}" style="{{this.displayStyle}} font-size: 16px;"></i>
                                    {{else if (eq this.displayType "text")}}
                                    <span
                                        style="{{this.displayStyle}} font-size: 14px; line-height: 1;">{{this.displayContent}}</span>
                                    {{/if}}
                                </div>
                            </div>
                            <div class="pin-info flexcol"
                                style="flex: 1; min-width: 0; justify-content: center; padding: 4px 8px;">
                                <span class="pin-name">{{this.name}}</span>
                                {{#if this.pageName}}
                                <span class="pin-page-name">{{this.pageName}}</span>
                                {{/if}}
                                <div class="pin-controls flexrow">
                                    <a class="pin-control" data-action="ping-pin" title="Ping Pin"><i
                                            class="fa-solid fa-bullseye"></i></a>
                                    <a class="pin-control" data-action="bring-players" title="Bring Players Here"><i
                                            class="fa-solid fa-location-crosshairs"></i></a>
                                    <a class="pin-control" data-action="pan" title="Pan to Pin"><i
                                            class="fas fa-crosshairs"></i></a>
                                    <a class="pin-control" data-action="copy-style" title="Copy Style"><i
                                            class="fa-solid fa-copy"></i></a>
                                    <a class="pin-control" data-action="paste-style" title="Paste Style"><i
                                            class="fa-solid fa-paste"></i></a>
                                    <a class="pin-control" data-action="duplicate-pin" title="Duplicate Pin"><i
                                            class="fa-solid fa-clone"></i></a>
                                    <a class="pin-control" data-action="edit-pin" title="Edit Pin"><i
                                            class="fa-solid fa-pen"></i></a>
                                    <a class="pin-control danger" data-action="delete-pin" title="Delete Pin"><i
                                            class="fa-solid fa-trash" style="color: #ff3333;"></i></a>
                                </div>
                            </div>
                            <div class="pin-sidebar flexcol"
                                style="flex: 0 0 50px; width: 50px; border-left: 1px solid #85733f; align-items: center; justify-content: center; gap: 4px; margin: 0; padding: 0;">
                                <a class="pin-control toggle-gm-only" data-action="toggle-gm-only"
                                    title="{{#if this.gmOnly}}Make Visible to Players{{else}}Make GM Only{{/if}}">
                                    <i class="fa-solid {{#if this.gmOnly}}fa-eye-slash{{else}}fa-eye{{/if}}" {{#if
                                        this.gmOnly}}style="color: #ff3333;" {{else}}style="color: #44cc44;"
                                        {{/if}}></i>
                                </a>
                                <a class="pin-control toggle-vision" data-action="toggle-vision"
                                    title="Toggle Require Line of Sight: {{#if this.requiresVision}}ON{{else}}OFF{{/if}}">
                                    <i class="fa-solid fa-binoculars" {{#if this.requiresVision}}style="color: #44cc44;"
                                        {{else}}style="color: #888888;" {{/if}} style="font-size: 0.9em;"></i>
                                </a>
                            </div>
                        </li>
                        {{/each}}
                    </ul>
                    {{/if}}

                    {{#if mapNotes.length}}
                    <div class="section-divider">
                        <span class="divider-text">MAP NOTES</span>
                    </div>
                    <ul class="sdx-pin-list map-notes-list">
                        {{#each mapNotes}}
                        <li class="pin-entry map-note-entry flexrow" data-id="{{this.id}}" data-uuid="{{this.uuid}}"
                            data-x="{{this.x}}" data-y="{{this.y}}" style="align-items: stretch; padding: 0;">
                            <div
                                style="flex: 0 0 50px; width: 50px; display: flex; align-items: center; justify-content: center; border-right: 1px solid #85733f;">
                                <div class="pin-icon"
                                    style="display: flex; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.5); border: 2px solid #85733f; border-radius: 4px; width: 32px; height: 32px;">
                                    <img src="{{this.img}}"
                                        style="display: block; width: 24px; height: 24px; object-fit: contain;"
                                        alt="Icon" />
                                </div>
                            </div>
                            <div class="pin-info flexcol"
                                style="flex: 1; min-width: 0; justify-content: center; padding: 4px 8px;">
                                <span class="pin-name">{{this.name}}</span>
                                <div class="pin-controls flexrow">
                                    <a class="map-note-control" data-action="open" title="Open Note"><i
                                            class="fa-solid fa-book-open"></i></a>
                                    <a class="map-note-control" data-action="pan" title="Pan to Note"><i
                                            class="fas fa-crosshairs"></i></a>
                                    {{#if this.canDelete}}
                                    <a class="map-note-control danger" data-action="delete" title="Delete Note"><i
                                            class="fa-solid fa-trash" style="color: #ff3333;"></i></a>
                                    {{/if}}
                                </div>
                            </div>
                        </li>
                        {{/each}}
                    </ul>
                    {{/if}}

                    {{#unless (or pins.length mapNotes.length)}}
                    <div class="no-character-message">
                        <p>No Pins or Notes Found</p>
                        <p>Add pins or map notes to the scene to see them here</p>
                    </div>
                    {{/unless}}
                </div>
            </div>
            <!-- NOTES TAB -->
            <div class="tray-view-content notes-view {{#unless (eq viewMode 'notes')}}hidden{{/unless}}"
                style="overflow-y: hidden; display: flex; flex-direction: column;">

                <!-- Note List Content -->
                <div class="note-list-scroll-container"
                    style="flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(255, 255, 255, 0.2) rgba(0, 0, 0, 0.1);">
                    {{#if notes.length}}
                    <ul class="sdx-note-list">
                        {{#each notes}}
                        <li class="note-entry {{#if (and ../isGM (not this.isVisible))}}hidden-note{{/if}}"
                            data-id="{{this.id}}" data-x="{{this.x}}" data-y="{{this.y}}">
                            <div class="note-header">
                                <span class="toggle-icon"><i class="fas fa-chevron-right"></i></span>
                                <div class="note-icon"><i class="{{this.icon}}"></i></div>
                                <span class="note-name">{{this.name}}</span>
                                <div class="note-controls">
                                    {{#if ../isGM}}
                                    <a class="note-control" data-action="toggle-visibility"
                                        title="{{#if this.isVisible}}Make Hidden{{else}}Make Visible{{/if}}">
                                        <i class="fas {{#if this.isVisible}}fa-eye{{else}}fa-eye-slash{{/if}}"
                                            style="{{#if this.isVisible}}color: #4ade80;{{else}}color: #999;{{/if}}"></i>
                                    </a>
                                    <a class="note-control" data-action="rename" title="Rename Note"><i
                                            class="fas fa-pen"></i></a>
                                    <a class="note-control danger" data-action="delete" title="Delete Note"><i
                                            class="fas fa-times" style="color: #ff3333;"></i></a>
                                    {{/if}}
                                    <a class="note-control" data-action="pan" title="Pan to Object"><i
                                            class="fas fa-crosshairs"></i></a>
                                </div>
                            </div>
                            <div class="note-content hidden">
                                {{{this.content}}}
                            </div>
                        </li>
                        {{/each}}
                    </ul>
                    {{else}}
                    <div class="no-character-message">
                        <p>No Notes Found</p>
                        <p>Add notes to placeables to see them here</p>
                    </div>
                    {{/if}}
                </div>

                {{#if isGM}}
                <div class="tray-footer-message">
                    Right click to edit a note content
                </div>
                {{/if}}

            </div>

            <!-- HEXES TAB (GM ONLY) -->
            {{#if isGM}}
            <div class="tray-view-content hexes-view {{#unless (eq viewMode 'hexes')}}hidden{{/unless}}"
                style="overflow-y: hidden; display: flex; flex-direction: column;">

                <!-- Format Map Controls -->
                <div class="hex-format-section">
                    <button class="hex-format-btn" data-action="hex-format-scene">
                        <i class="fas fa-ruler-combined"></i> Format Map
                    </button>
                    <div class="hex-format-controls hidden">
                        <div class="hex-slider-row">
                            <label>Width</label>
                            <input type="range" name="hex-columns" min="5" max="50" step="1" value="{{hexColumns}}">
                            <span class="hex-slider-value">{{hexColumns}}</span>
                        </div>
                        <div class="hex-slider-row">
                            <label>Height</label>
                            <input type="range" name="hex-rows" min="5" max="50" step="1" value="{{hexRows}}">
                            <span class="hex-slider-value">{{hexRows}}</span>
                        </div>
                        <button class="hex-apply-btn" data-action="hex-apply-format">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                </div>

                <!-- Tile Search Filter -->
                <div class="hex-search-section">
                    <input type="text" class="hex-search-input" placeholder="Search tiles..."
                        value="{{hexSearchFilter}}" />
                </div>

                <!-- Effect Toggles -->
                <div class="hex-effects-section">
                    <div class="hex-effects-grid">
                        <label class="hex-fx-toggle">
                            <input type="checkbox" class="hex-water-checkbox" {{#if waterEffect}}checked{{/if}} />
                            <span><i class="fas fa-water"></i> Water</span>
                        </label>
                        <label class="hex-fx-toggle">
                            <input type="checkbox" class="hex-wind-checkbox" {{#if windEffect}}checked{{/if}} />
                            <span><i class="fas fa-wind"></i> Wind</span>
                        </label>
                        <label class="hex-fx-toggle">
                            <input type="checkbox" class="hex-fog-checkbox" {{#if fogAnimation}}checked{{/if}} />
                            <span><i class="fas fa-cloud"></i> Fog</span>
                        </label>
                        <label class="hex-fx-toggle">
                            <input type="checkbox" class="hex-tint-checkbox" {{#if tintEnabled}}checked{{/if}} />
                            <span><i class="fas fa-palette"></i> Tinted</span>
                        </label>
                        <label class="hex-fx-toggle">
                            <input type="checkbox" class="hex-bw-checkbox" {{#if bwEffect}}checked{{/if}} />
                            <span><i class="fas fa-adjust"></i> B&W</span>
                        </label>
                    </div>
                </div>

                <!-- Tile Grid -->
                <div class="hex-tile-scroll"
                    style="flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.2) rgba(0,0,0,0.1);">

                    <!-- Procedural Generator (hidden on symbols tab) -->
                    <div class="hex-generator-section {{#if (eq activeTileTab 'symbols')}}hidden{{/if}}">
                        <button class="hex-generator-toggle-btn" data-action="hex-generator-toggle">
                            <i class="fas fa-dice-d20"></i> Procedural Generator
                        </button>
                        <div class="hex-generator-controls hidden">
                            <div class="hex-gen-slider-row">
                                <label><i class="fas fa-water"></i> Water</label>
                                <input type="range" name="hex-gen-water" min="-50" max="50" step="5" value="0">
                                <span class="hex-gen-slider-value">0</span>
                            </div>
                            <div class="hex-gen-slider-row">
                                <label><i class="fas fa-tree"></i> Vegetation</label>
                                <input type="range" name="hex-gen-green" min="-50" max="50" step="5" value="0">
                                <span class="hex-gen-slider-value">0</span>
                            </div>
                            <div class="hex-gen-slider-row">
                                <label><i class="fas fa-mountain"></i> Mountains</label>
                                <input type="range" name="hex-gen-mountain" min="-50" max="50" step="5" value="0">
                                <span class="hex-gen-slider-value">0</span>
                            </div>
                            <div class="hex-gen-slider-row">
                                <label><i class="fas fa-sun"></i> Desert</label>
                                <input type="range" name="hex-gen-desert" min="-50" max="50" step="5" value="0">
                                <span class="hex-gen-slider-value">0</span>
                            </div>
                            <div class="hex-gen-slider-row">
                                <label><i class="fas fa-frog"></i> Swamp</label>
                                <input type="range" name="hex-gen-swamp" min="-50" max="50" step="5" value="0">
                                <span class="hex-gen-slider-value">0</span>
                            </div>
                            <div class="hex-gen-slider-row">
                                <label><i class="fas fa-skull"></i> Badlands</label>
                                <input type="range" name="hex-gen-badlands" min="-50" max="50" step="5" value="0">
                                <span class="hex-gen-slider-value">0</span>
                            </div>
                            <div class="hex-gen-slider-row">
                                <label><i class="fas fa-snowflake"></i> Snow</label>
                                <input type="range" name="hex-gen-snow" min="-50" max="50" step="5" value="0">
                                <span class="hex-gen-slider-value">0</span>
                            </div>
                            <div class="hex-gen-seed-row">
                                <label><i class="fas fa-seedling"></i> Seed</label>
                                <input type="text" name="hex-gen-seed" class="hex-gen-seed-input" placeholder="Random"
                                    value="">
                            </div>
                            <div class="hex-gen-buttons">
                                <button class="hex-gen-btn hex-gen-generate-btn" data-action="hex-generate">
                                    <i class="fas fa-magic"></i> Generate
                                </button>
                                <button class="hex-gen-btn hex-gen-clear-btn" data-action="hex-clear">
                                    <i class="fas fa-trash"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tile Tabs -->
                    <div class="hex-tile-tabs">
                        <button class="hex-tile-tab {{#if (eq activeTileTab 'default')}}active{{/if}}" data-tile-tab="default">Default</button>
                        <button class="hex-tile-tab {{#if (eq activeTileTab 'colored')}}active{{/if}}" data-tile-tab="colored">Colored</button>
                        <button class="hex-tile-tab {{#if (eq activeTileTab 'custom')}}active{{/if}}" data-tile-tab="custom">Custom</button>
                        <button class="hex-tile-tab {{#if (eq activeTileTab 'symbols')}}active{{/if}}" data-tile-tab="symbols">POI</button>
                    </div>

                    <!-- Colored Tile Info (only shown on colored tab) -->
                    {{#if (eq activeTileTab 'colored')}}
                    <div class="hex-custom-size-section">
                        <div class="hex-custom-folder-hint">
                            <i class="fas fa-info-circle"></i> Size: {{coloredTileWidth}}Ã—{{coloredTileHeight}}
                        </div>
                    </div>
                    {{/if}}

                    <!-- POI Tile Info (only shown on symbols tab) -->
                    {{#if (eq activeTileTab 'symbols')}}
                    <div class="hex-custom-size-section">
                        <div class="hex-custom-folder-hint">
                            <i class="fas fa-info-circle"></i> POI paint on top, don't replace tiles
                        </div>
                    </div>
                    {{/if}}

                    <!-- Custom Tile Size Controls (only shown on custom tab) -->
                    {{#if (eq activeTileTab 'custom')}}
                    <div class="hex-custom-size-section">
                        <div class="hex-custom-size-row">
                            <label>W:</label>
                            <input type="number" class="hex-custom-size-input" name="custom-tile-width"
                                   min="50" max="1000" step="1" value="{{customTileWidth}}">
                            <label>H:</label>
                            <input type="number" class="hex-custom-size-input" name="custom-tile-height"
                                   min="50" max="1000" step="1" value="{{customTileHeight}}">
                        </div>
                        <div class="hex-custom-folder-hint">
                            <i class="fas fa-info-circle"></i> Add tiles to <code>Data/hexes/</code>
                        </div>
                    </div>
                    {{/if}}

                    <!-- Default Tiles Grid -->
                    <div class="hex-tile-grid {{#unless (eq activeTileTab 'default')}}hidden{{/unless}}" data-tile-panel="default">
                        {{#each hexTiles}}
                        <div class="hex-tile-thumb {{#if this.active}}active{{/if}}" data-tile="{{this.path}}"
                            title="{{this.label}}">
                            <img src="{{this.path}}" alt="{{this.label}}" />
                            <span class="hex-tile-label">{{this.label}}</span>
                        </div>
                        {{/each}}
                    </div>

                    <!-- Colored Tiles Grid -->
                    <div class="hex-tile-grid {{#unless (eq activeTileTab 'colored')}}hidden{{/unless}}" data-tile-panel="colored">
                        {{#if hexColoredTiles.length}}
                            {{#each hexColoredTiles}}
                            <div class="hex-tile-thumb {{#if this.active}}active{{/if}}" data-tile="{{this.path}}"
                                title="{{this.label}}{{#if this.biome}} ({{this.biome}}){{/if}}">
                                <img src="{{this.path}}" alt="{{this.label}}" />
                                <span class="hex-tile-label">{{this.label}}</span>
                                {{#if this.biome}}<span class="hex-tile-biome">{{this.biome}}</span>{{/if}}
                            </div>
                            {{/each}}
                        {{else}}
                            <div class="hex-no-custom-tiles">
                                <p><i class="fas fa-palette"></i></p>
                                <p>No colored tiles found</p>
                            </div>
                        {{/if}}
                    </div>

                    <!-- Custom Tiles Grid -->
                    <div class="hex-tile-grid {{#unless (eq activeTileTab 'custom')}}hidden{{/unless}}" data-tile-panel="custom">
                        {{#if hexCustomTiles.length}}
                            {{#each hexCustomTiles}}
                            <div class="hex-tile-thumb {{#if this.active}}active{{/if}}" data-tile="{{this.path}}"
                                title="{{this.label}}{{#if this.biome}} ({{this.biome}}){{/if}}">
                                <img src="{{this.path}}" alt="{{this.label}}" />
                                <span class="hex-tile-label">{{this.label}}</span>
                                {{#if this.biome}}<span class="hex-tile-biome">{{this.biome}}</span>{{/if}}
                            </div>
                            {{/each}}
                        {{else}}
                            <div class="hex-no-custom-tiles">
                                <p><i class="fas fa-folder-open"></i></p>
                                <p>No custom tiles found</p>
                                <p class="hex-custom-hint">Add .png or .webp files to:<br><code>Data/hexes/</code></p>
                                <p class="hex-custom-hint">Biome folders:<br>
                                    <code>water</code>, <code>vegetation</code>, <code>mountains</code>,<br>
                                    <code>desert</code>, <code>swamp</code>, <code>badlands</code>
                                </p>
                            </div>
                        {{/if}}
                    </div>

                    <!-- Symbol Tiles Grid -->
                    <div class="hex-tile-grid {{#unless (eq activeTileTab 'symbols')}}hidden{{/unless}}" data-tile-panel="symbols">
                        {{#if hexSymbolTiles.length}}
                            {{#each hexSymbolTiles}}
                            <div class="hex-tile-thumb {{#if this.active}}active{{/if}}" data-tile="{{this.path}}"
                                title="{{this.label}}{{#if this.category}} ({{this.category}}){{/if}}">
                                <img src="{{this.path}}" alt="{{this.label}}" />
                                <span class="hex-tile-label">{{this.label}}</span>
                                {{#if this.category}}<span class="hex-tile-biome">{{this.category}}</span>{{/if}}
                            </div>
                            {{/each}}
                        {{else}}
                            <div class="hex-no-custom-tiles">
                                <p><i class="fas fa-map-marker-alt"></i></p>
                                <p>No symbol tiles found</p>
                            </div>
                        {{/if}}
                    </div>
                </div>

                <!-- Usage hints -->
                <div class="tray-footer-message">
                    Drag to paint Â· Shift+Drag to erase
                </div>
            </div>
            {{/if}}
        </div>
    </div>