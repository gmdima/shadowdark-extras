<div class="tom-layout">

  <!-- ═══════════════════════════════════════════════════════════════
       LIBRARY (Main Content)
       ═══════════════════════════════════════════════════════════════ -->
  <main class="tom-library">
    <!-- Breadcrumbs -->
    <nav class="tom-breadcrumbs">
      <span class="tom-breadcrumb-item {{#unless (or isInFolder isFavorites selectedItem)}}active{{/unless}}"
        data-action="view" data-view="{{#if (eq activeTab 'scenes')}}scenes-all{{else}}characters-all{{/if}}">
        <i class="fas {{#if (eq activeTab 'scenes')}}fa-film{{else}}fa-users{{/if}}"></i>
        {{#if (eq activeTab 'scenes')}}Scenes{{else}}Characters{{/if}}
      </span>
      {{#if isFavorites}}
      <i class="fas fa-chevron-right tom-breadcrumb-sep"></i>
      <span class="tom-breadcrumb-item active">
        <i class="fas fa-star"></i> Favorites
      </span>
      {{/if}}
      {{#each folderPath}}
      <i class="fas fa-chevron-right tom-breadcrumb-sep"></i>
      <span
        class="tom-breadcrumb-item {{#if (eq @index (subtract ../folderPath.length 1))}}{{#unless ../selectedItem}}active{{/unless}}{{/if}}"
        data-action="open-folder" data-folder-id="{{id}}" title="{{name}}">
        <i class="fas fa-folder"></i> {{name}}
      </span>
      {{/each}}
      {{#if selectedItem}}
      <i class="fas fa-chevron-right tom-breadcrumb-sep"></i>
      <span class="tom-breadcrumb-item active" title="{{selectedItem.name}}">
        {{selectedItem.name}}
      </span>
      {{/if}}
    </nav>

    <header class="tom-library-header">
      <div class="tom-search-container">
        <i class="fas fa-search tom-search-icon"></i>
        <input type="text" class="tom-search-input" placeholder="Search..." value="{{searchQuery}}" name="search"
          aria-label="Search scenes and characters">
        {{#if isSearching}}
        <i class="fas fa-spinner fa-spin tom-search-loading"></i>
        {{/if}}
        {{#if searchQuery}}
        <button class="tom-search-clear" data-action="clear-search" title="Clear search">
          <i class="fas fa-times"></i>
        </button>
        {{/if}}
      </div>
    </header>

    <!-- Active Filters -->
    {{#if (or activeTags.length excludedTags.length)}}
    <div class="tom-filter-bar">
      <div class="tom-filter-label">Active Filters:</div>
      {{#each activeTags}}
      <div class="tom-filter-chip include" data-action="remove-filter" data-tag="{{this}}" data-type="include">
        {{this}} <i class="fas fa-times"></i>
      </div>
      {{/each}}
      {{#each excludedTags}}
      <div class="tom-filter-chip exclude" data-action="remove-filter" data-tag="{{this}}" data-type="exclude">
        <i class="fas fa-ban"></i> {{this}} <i class="fas fa-times"></i>
      </div>
      {{/each}}
    </div>
    {{/if}}

    <div class="tom-grid {{#if (eq viewMode 'list')}}list-view{{/if}}">
      {{!-- Back to Parent Folder --}}
      {{#if isInFolder}}
      <div class="tom-folder-card tom-folder-back" data-action="navigate-up">
        <div class="tom-folder-icon">
          <i class="fas fa-level-up-alt"></i>
        </div>
        <div class="tom-folder-name">..</div>
      </div>
      {{/if}}

      {{!-- Folders --}}
      {{#each folders}}
      <div class="tom-folder-card" data-folder-id="{{id}}" data-action="open-folder" {{#if color}}data-color="{{color}}"
        style="--folder-color: {{color}}" {{/if}}>
        <div class="tom-folder-icon">
          <i class="fas fa-folder"></i>
        </div>
        <div class="tom-folder-name" title="{{name}}">{{name}}</div>
        <div class="tom-folder-meta">
          {{itemCount}} item{{#if (gt itemCount 1)}}s{{/if}}
          {{#if subfolderCount}}, {{subfolderCount}} folder{{#if (gt subfolderCount 1)}}s{{/if}}{{/if}}
        </div>
        <div class="tom-folder-actions">
          <div class="tom-folder-color-btn" title="Change Color">
            <i class="fas fa-palette"></i>
            <input type="color" value="{{#if color}}{{color}}{{else}}#d4af37{{/if}}" data-action="change-folder-color">
          </div>
          <button class="tom-folder-action" data-action="rename-folder" title="Rename">
            <i class="fas fa-edit"></i>
          </button>
          <button class="tom-folder-action" data-action="delete-folder" title="Delete">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
      {{/each}}

      {{!-- Items --}}
      {{#each items}}
      <div class="tom-card {{#if (eq ../selectedId id)}}selected{{/if}} {{#if favorite}}is-favorite{{/if}}"
        data-id="{{id}}" data-type="{{type}}" data-action="select">

        <div class="tom-card-thumbnail {{#if (eq bgType 'video')}}has-video{{/if}}">
          {{!-- Use video element for video thumbnails, image for others --}}
          {{#if (eq bgType 'video')}}
          <video class="thumbnail-preview" src="{{thumbnail}}" muted loop preload="metadata"></video>
          {{else}}
          <img src="{{thumbnail}}" loading="lazy">
          {{/if}}
          {{!-- Video indicator badge --}}
          {{#if (eq bgType 'video')}}
          <div class="tom-video-badge" title="Animated Background (Video)">
            <i class="fas fa-film"></i>
          </div>
          {{/if}}
          {{!-- Favorite indicator (always visible when favorited) --}}
          <button class="tom-favorite-btn {{#if favorite}}active{{/if}}" data-action="toggle-favorite" data-id="{{id}}"
            data-type="{{type}}" title="{{#if favorite}}Remove from Favorites{{else}}Add to Favorites{{/if}}">
            <i class="{{#if favorite}}fas{{else}}far{{/if}} fa-star"></i>
          </button>
          <div class="tom-card-overlay">
            {{#if (and (eq type 'scene') (eq id ../activeSceneId))}}
            <button class="tom-action-btn active" data-action="stop-broadcast" title="Stop Broadcasting">
              <i class="fas fa-stop"></i>
            </button>
            {{else if (eq type 'scene')}}
            <button class="tom-action-btn" data-action="broadcast" title="Broadcast">
              <i class="fas fa-play"></i>
            </button>
            {{/if}}
            <button class="tom-action-btn" data-action="edit" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            {{#if (eq type 'character')}}
            {{!-- Toggle in Active Scene --}}
            <button class="tom-action-btn {{#if isInActiveScene}}active{{/if}}" data-action="toggle-cast"
              title="{{#if isInActiveScene}}Remove from Active Scene{{else}}Add to Active Scene{{/if}}">
              <i class="fas {{#if isInActiveScene}}fa-times-circle{{else}}fa-plus-circle{{/if}}"></i>
            </button>
            {{/if}}
            <button class="tom-action-btn tom-action-btn-danger" data-action="delete" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <div class="tom-card-body">
          <div class="tom-card-title" title="{{name}}">{{name}}</div>
          {{#if (and (eq ../viewMode 'list') folderName)}}
          <div class="tom-card-folder"><i class="fas fa-folder"></i> {{folderName}}</div>
          {{/if}}
          <div class="tom-card-tags">
            {{#each tags}}
            <span class="tom-tag-badge" data-action="filter-tag" data-tag="{{this}}"
              title="Click to filter, Shift+Click to exclude">{{this}}</span>
            {{/each}}
          </div>
        </div>
      </div>
      {{/each}}

      {{!-- Empty State (simple text) --}}
      {{#unless (or items.length folders.length isInFolder)}}
      <div
        class="tom-empty-state {{#if (eq activeTab 'scenes')}}scenes{{else}}characters{{/if}} {{#if hasFilters}}no-results{{/if}}">
        <div class="tom-empty-text">
          {{#if hasFilters}}
          No results found
          {{else if (eq activeTab 'scenes')}}
          No Scenes yet
          {{else}}
          No Characters yet
          {{/if}}
        </div>
      </div>
      {{/unless}}
    </div>


    <button class="tom-fab" data-action="create"
      title="Create New {{#if (eq activeTab 'scenes')}}Scene{{else}}Character{{/if}}">
      <i class="fas fa-plus"></i>
    </button>
  </main>

  <aside class="tom-sidebar">

    <div class="tom-sidebar-section">
      <div class="tom-sidebar-header">SCENES</div>
      <nav class="tom-nav">
        <div class="tom-nav-item {{#if (eq currentView 'scenes-all')}}active{{/if}}" data-action="view"
          data-view="scenes-all">
          <i class="fas fa-film"></i>
          <span>All Scenes</span>
          {{#if activeSceneId}}<span class="tom-active-indicator" title="Broadcasting"></span>{{/if}}
          <span class="tom-nav-count">{{counts.scenesAll}}</span>
        </div>
      </nav>
    </div>

    <!-- Characters Section -->
    <div class="tom-sidebar-section">
      <div class="tom-sidebar-header">CHARACTERS</div>
      <nav class="tom-nav">
        <div class="tom-nav-item {{#if (eq currentView 'characters-all')}}active{{/if}}" data-action="view"
          data-view="characters-all">
          <i class="fas fa-users"></i>
          <span>All Characters</span>
          <span class="tom-nav-count">{{counts.charactersAll}}</span>
        </div>

      </nav>
    </div>
  </aside>


  <!-- Emotion Picker Popover -->
  {{#if emotionPicker}}
  <div class="tom-emotion-picker {{#if (gt emotionPicker.emotions.length 5)}}has-search{{/if}}"
    style="left: {{emotionPicker.x}}px; top: {{emotionPicker.y}}px;">
    <div class="tom-picker-header">
      <span>{{emotionPicker.character.name}}</span>
      <button class="tom-btn-icon small" data-action="close-picker" title="Close"><i class="fas fa-times"></i></button>
    </div>
    {{!-- Search field for 6+ emotions --}}
    {{#if (gt emotionPicker.emotions.length 5)}}
    <div class="tom-picker-search">
      <i class="fas fa-search"></i>
      <input type="text" class="tom-picker-search-input" placeholder="Search emotions..." data-action="search-emotions"
        aria-label="Search emotions">
    </div>
    {{/if}}
    <div class="tom-picker-grid">
      {{!-- Emotions are already sorted: favorites first, then alphabetically --}}
      {{#each emotionPicker.emotions}}
      <div
        class="tom-picker-item {{#if (eq ../emotionPicker.character.currentState key)}}active{{/if}} {{#if isFavorite}}is-favorite{{/if}}"
        data-action="select-emotion" data-state="{{key}}" data-path="{{path}}"
        title="{{key}}{{#if isFavorite}} (Favorite){{/if}}">
        <button class="tom-emotion-fav-btn {{#if isFavorite}}active{{/if}}" data-action="toggle-emotion-favorite"
          data-state="{{key}}" title="{{#if isFavorite}}Remove from favorites{{else}}Add to favorites{{/if}}">
          <i class="{{#if isFavorite}}fas{{else}}far{{/if}} fa-star"></i>
        </button>
        <img src="{{path}}">
        <span class="tom-picker-label">{{key}}</span>
      </div>
      {{/each}}
    </div>
    {{!-- Preview panel --}}
    <div class="tom-picker-preview" style="display: none;">
      <img src="" alt="Preview">
      <span class="tom-picker-preview-label"></span>
    </div>
    <div class="tom-picker-footer">
      <button class="tom-btn tom-btn-danger small" data-action="remove-cast">
        <i class="fas fa-user-minus"></i> Remove from Scene
      </button>
    </div>
  </div>
  {{/if}}

</div>