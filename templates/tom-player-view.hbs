<div class="tom-player-view {{#if active}}active{{/if}} {{#if castOnlyMode}}cast-only-mode{{/if}}"
  data-scene-id="{{scene.id}}">

  {{#unless castOnlyMode}}
  <div class="tom-pv-background">
    {{#if scene}}
    {{#if (eq scene.bgType 'video')}}
    <video class="tom-pv-bg-media" src="{{scene.background}}" muted loop autoplay playsinline
      disablepictureinpicture></video>
    {{else}}
    <img src="{{scene.background}}" class="tom-pv-bg-media">
    {{/if}}
    {{else}}
    <div class="tom-pv-placeholder"></div>
    {{/if}}
  </div>


  <div class="tom-pv-overlay"></div>


  {{#if isArena}}
  <!-- Arena Assets Container (GM-only images, below tokens) -->
  <div class="tom-arena-assets">
    {{#each arenaAssets}}
    <div class="tom-arena-asset {{#if @root.isGM}}gm-control{{/if}}" data-asset-id="{{assetId}}"
      style="left: {{x}}%; top: {{y}}%; transform: translate(-50%, -50%) scale({{scale}});">
      <img src="{{image}}" alt="Asset">
    </div>
    {{/each}}
  </div>

  <!-- Arena Tokens Container -->
  <div class="tom-arena-tokens">
    {{#each arenaTokens}}
    <div class="tom-arena-token {{#if isNPC}}npc{{/if}} {{#if isOwner}}draggable{{/if}}" data-token-id="{{tokenId}}"
      data-owner-id="{{ownerId}}" data-actor-id="{{actorId}}" data-actor-type="{{actorType}}"
      style="left: {{x}}%; top: {{y}}%;">
      <div class="tom-arena-token-portrait">
        <img src="{{image}}" alt="{{actorName}}">
      </div>
      <div class="tom-arena-token-info">
        {{#if isOwner}}
        <div class="tom-arena-token-ac">{{ac}}</div>
        {{/if}}
        <div class="tom-arena-token-name">{{actorName}}</div>
        {{#if isOwner}}
        <div class="tom-arena-token-hp">{{hpValue}}/{{hpMax}}</div>
        {{/if}}
      </div>
    </div>
    {{/each}}
  </div>

  <div class="tom-arena-rings">
    <svg viewBox="0 -50 1000 700" preserveAspectRatio="xMidYMid meet">
      <defs>
        <!-- Glow filter for the rings -->
        <filter id="arenaGlow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="3" result="coloredBlur" />
          <feMerge>
            <feMergeNode in="coloredBlur" />
            <feMergeNode in="SourceGraphic" />
          </feMerge>
        </filter>
        <!-- Gradient for ring stroke -->
        <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
          <stop offset="50%" style="stop-color:#fbbf24;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
        </linearGradient>
      </defs>

      {{#if (eq scene.arenaType 'topdown')}}
      <!-- Top Down (Concentric Circles) -->
      <!-- Outer ring (Far) -->
      <circle cx="500" cy="300" r="280" class="tom-arena-ring tom-arena-ring-90" fill="none" stroke="url(#ringGradient)"
        stroke-width="2" filter="url(#arenaGlow)" opacity="0.7" />
      <text x="500" y="10" class="tom-arena-label" text-anchor="middle">FAR</text>

      <!-- Inner ring (Near) -->
      <circle cx="500" cy="300" r="140" class="tom-arena-ring tom-arena-ring-30" fill="none" stroke="url(#ringGradient)"
        stroke-width="2" filter="url(#arenaGlow)" opacity="0.9" />
      <text x="500" y="150" class="tom-arena-label" text-anchor="middle">NEAR</text>

      <!-- Close area -->
      <circle cx="500" cy="300" r="140" class="tom-arena-center" fill="rgba(251, 191, 36, 0.1)"
        stroke="url(#ringGradient)" stroke-width="3" filter="url(#arenaGlow)" />
      <text x="500" y="305" class="tom-arena-label tom-arena-label-center" text-anchor="middle">CLOSE</text>

      {{else if (eq scene.arenaType 'expanded')}}
      <!-- Expanded (Radial Grid) -->
      <!-- Colors based on image: Red (Engaged), Orange (Short), Yellow (Medium), Green (Long), Blue (Extreme) -->

      <!-- EXTREME (Blue) -->
      <circle cx="500" cy="300" r="320" fill="rgba(59, 130, 246, 0.1)" stroke="#3b82f6" stroke-width="2"
        opacity="0.8" />

      <!-- LONG (Green) -->
      <circle cx="500" cy="300" r="255" fill="rgba(34, 197, 94, 0.1)" stroke="#22c55e" stroke-width="2" opacity="0.8" />

      <!-- MEDIUM (Yellow) -->
      <circle cx="500" cy="300" r="190" fill="rgba(234, 179, 8, 0.1)" stroke="#eab308" stroke-width="2" opacity="0.8" />

      <!-- SHORT (Orange) -->
      <circle cx="500" cy="300" r="125" fill="rgba(249, 115, 22, 0.1)" stroke="#f97316" stroke-width="2"
        opacity="0.8" />

      <!-- ENGAGED (Red) center -->
      <circle cx="500" cy="300" r="55" fill="rgba(239, 68, 68, 0.3)" stroke="#ef4444" stroke-width="4" />
      <text x="500" y="305" fill="#fff"
        style="font-weight: bold; font-family: sans-serif; font-size: 14px; text-shadow: 0 0 4px #000;"
        text-anchor="middle">ENGAGED</text>

      <!-- Labels -->
      <text x="500" y="212" fill="#fff"
        style="font-weight: bold; font-family: sans-serif; font-size: 12px; text-shadow: 0 0 4px #000;"
        text-anchor="middle">SHORT</text>
      <text x="500" y="146" fill="#fff"
        style="font-weight: bold; font-family: sans-serif; font-size: 12px; text-shadow: 0 0 4px #000;"
        text-anchor="middle">MEDIUM</text>
      <text x="500" y="80" fill="#fff"
        style="font-weight: bold; font-family: sans-serif; font-size: 12px; text-shadow: 0 0 4px #000;"
        text-anchor="middle">LONG</text>
      <text x="500" y="14" fill="#fff"
        style="font-weight: bold; font-family: sans-serif; font-size: 12px; text-shadow: 0 0 4px #000;"
        text-anchor="middle">EXTREME</text>

      <!-- Radial Lines (12 sectors = 30 degrees each) -->
      <g stroke="#000" stroke-width="2" opacity="0.5">
        <line x1="500" y1="50" x2="500" y2="10" transform="rotate(0 500 300)" />
        <line x1="500" y1="50" x2="500" y2="10" transform="rotate(30 500 300)" />
        <line x1="500" y1="50" x2="500" y2="10" transform="rotate(60 500 300)" />
        <line x1="500" y1="50" x2="500" y2="10" transform="rotate(90 500 300)" />
        <line x1="500" y1="50" x2="500" y2="10" transform="rotate(120 500 300)" />
        <line x1="500" y1="50" x2="500" y2="10" transform="rotate(150 500 300)" />
        <line x1="500" y1="50" x2="500" y2="10" transform="rotate(180 500 300)" />
        <line x1="500" y1="50" x2="500" y2="10" transform="rotate(210 500 300)" />
        <line x1="500" y1="50" x2="500" y2="10" transform="rotate(240 500 300)" />
        <line x1="500" y1="50" x2="500" y2="10" transform="rotate(270 500 300)" />
        <line x1="500" y1="50" x2="500" y2="10" transform="rotate(300 500 300)" />
        <line x1="500" y1="50" x2="500" y2="10" transform="rotate(330 500 300)" />
      </g>

      <!-- Full Radial lines for larger circles -->
      <g stroke="#000" stroke-width="1" opacity="0.3">
        <line x1="500" y1="300" x2="500" y2="10" transform="rotate(0 500 300)" />
        <line x1="500" y1="300" x2="500" y2="10" transform="rotate(30 500 300)" />
        <line x1="500" y1="300" x2="500" y2="10" transform="rotate(60 500 300)" />
        <line x1="500" y1="300" x2="500" y2="10" transform="rotate(90 500 300)" />
        <line x1="500" y1="300" x2="500" y2="10" transform="rotate(120 500 300)" />
        <line x1="500" y1="300" x2="500" y2="10" transform="rotate(150 500 300)" />
        <line x1="500" y1="300" x2="500" y2="10" transform="rotate(180 500 300)" />
        <line x1="500" y1="300" x2="500" y2="10" transform="rotate(210 500 300)" />
        <line x1="500" y1="300" x2="500" y2="10" transform="rotate(240 500 300)" />
        <line x1="500" y1="300" x2="500" y2="10" transform="rotate(270 500 300)" />
        <line x1="500" y1="300" x2="500" y2="10" transform="rotate(300 500 300)" />
        <line x1="500" y1="300" x2="500" y2="10" transform="rotate(330 500 300)" />
      </g>

      {{else if (eq scene.arenaType 'ladder')}}
      <!-- Ladder (Linear Track) -->
      <!-- A horizontal track with 5 zones: Engaged, Close, Near, Far, Out of Range -->

      <!-- Track background -->
      <rect x="50" y="250" width="900" height="100" rx="10" ry="10" fill="rgba(0,0,0,0.3)" stroke="#444"
        stroke-width="2" />

      <!-- Zone dividers and fills -->
      <!-- ENGAGED (Red) -->
      <rect x="50" y="250" width="180" height="100" rx="10" ry="0" fill="rgba(239, 68, 68, 0.4)" />
      <text x="140" y="310" fill="#fff"
        style="font-weight: bold; font-family: sans-serif; font-size: 16px; text-shadow: 0 0 4px #000;"
        text-anchor="middle">ENGAGED</text>

      <!-- CLOSE (Orange) -->
      <rect x="230" y="250" width="180" height="100" fill="rgba(249, 115, 22, 0.3)" />
      <text x="320" y="310" fill="#fff"
        style="font-weight: bold; font-family: sans-serif; font-size: 16px; text-shadow: 0 0 4px #000;"
        text-anchor="middle">CLOSE</text>

      <!-- NEAR (Yellow) -->
      <rect x="410" y="250" width="180" height="100" fill="rgba(234, 179, 8, 0.3)" />
      <text x="500" y="310" fill="#fff"
        style="font-weight: bold; font-family: sans-serif; font-size: 16px; text-shadow: 0 0 4px #000;"
        text-anchor="middle">NEAR</text>

      <!-- FAR (Green) -->
      <rect x="590" y="250" width="180" height="100" fill="rgba(34, 197, 94, 0.3)" />
      <text x="680" y="310" fill="#fff"
        style="font-weight: bold; font-family: sans-serif; font-size: 16px; text-shadow: 0 0 4px #000;"
        text-anchor="middle">FAR</text>

      <!-- OUT OF RANGE (Blue) -->
      <rect x="770" y="250" width="180" height="100" rx="0" ry="10" fill="rgba(59, 130, 246, 0.3)" />
      <text x="860" y="310" fill="#fff"
        style="font-weight: bold; font-family: sans-serif; font-size: 14px; text-shadow: 0 0 4px #000;"
        text-anchor="middle">OUT OF RANGE</text>

      <!-- Zone divider lines -->
      <line x1="230" y1="250" x2="230" y2="350" stroke="#888" stroke-width="2" />
      <line x1="410" y1="250" x2="410" y2="350" stroke="#888" stroke-width="2" />
      <line x1="590" y1="250" x2="590" y2="350" stroke="#888" stroke-width="2" />
      <line x1="770" y1="250" x2="770" y2="350" stroke="#888" stroke-width="2" />

      <!-- Arrows indicating direction -->
      <polygon points="30,300 50,280 50,320" fill="url(#ringGradient)" filter="url(#arenaGlow)" />
      <polygon points="970,300 950,280 950,320" fill="url(#ringGradient)" filter="url(#arenaGlow)" />

      {{else if (eq scene.arenaType 'isometric')}}
      <!-- Isometric (Ellipse - Default) -->
      <!-- Outer ring (Far) -->
      <ellipse cx="500" cy="300" rx="420" ry="210" class="tom-arena-ring tom-arena-ring-90" fill="none"
        stroke="url(#ringGradient)" stroke-width="2" filter="url(#arenaGlow)" opacity="0.7" />
      <text x="500" y="60" class="tom-arena-label" text-anchor="middle">FAR</text>

      <!-- Inner ring (Near) -->
      <ellipse cx="500" cy="300" rx="180" ry="90" class="tom-arena-ring tom-arena-ring-30" fill="none"
        stroke="url(#ringGradient)" stroke-width="2" filter="url(#arenaGlow)" opacity="0.9" />
      <text x="500" y="180" class="tom-arena-label" text-anchor="middle">NEAR</text>

      <!-- Close area (same size as inner ring) - rendered last to cover divider lines -->
      <ellipse cx="500" cy="300" rx="180" ry="90" class="tom-arena-ring tom-arena-center" fill="rgba(251, 191, 36, 0.1)"
        stroke="url(#ringGradient)" stroke-width="3" filter="url(#arenaGlow)" />
      <text x="500" y="305" class="tom-arena-label tom-arena-label-center" text-anchor="middle">CLOSE</text>

      {{else}}
      <!-- Fallback to Isometric if undefined, or nothing if 'none' (though 'none' usually implies !isArena) -->
      {{#if (eq scene.arenaType 'none')}}
      <!-- No grid rendered -->
      {{else}}
      <!-- Default Isometric Fallback -->
      <ellipse cx="500" cy="300" rx="420" ry="210" class="tom-arena-ring tom-arena-ring-90" fill="none"
        stroke="url(#ringGradient)" stroke-width="2" filter="url(#arenaGlow)" opacity="0.7" />
      <text x="500" y="60" class="tom-arena-label" text-anchor="middle">FAR</text>
      <ellipse cx="500" cy="300" rx="180" ry="90" class="tom-arena-ring tom-arena-ring-30" fill="none"
        stroke="url(#ringGradient)" stroke-width="2" filter="url(#arenaGlow)" opacity="0.9" />
      <text x="500" y="180" class="tom-arena-label" text-anchor="middle">NEAR</text>
      <ellipse cx="500" cy="300" rx="180" ry="90" class="tom-arena-ring tom-arena-center" fill="rgba(251, 191, 36, 0.1)"
        stroke="url(#ringGradient)" stroke-width="3" filter="url(#arenaGlow)" />
      <text x="500" y="305" class="tom-arena-label tom-arena-label-center" text-anchor="middle">CLOSE</text>
      {{/if}}
      {{/if}}
    </svg>
  </div>
  {{/if}}
  {{/unless}}


  <div class="tom-pv-cast" data-preset="{{layout.preset}}"
    style="--cast-size: {{layout.size}}; --cast-spacing: {{layout.spacing}}px; --cast-offset-x: {{layout.offsetX}}vh; --cast-offset-y: {{layout.offsetY}}vh;">
    {{#each cast}}
    <div class="tom-pv-character {{#if locked}}is-locked{{/if}}" data-id="{{id}}" data-action="character-click">
      <div class="tom-pv-portrait" data-border="{{borderStyle}}">
        <img src="{{image}}" alt="{{name}}">
      </div>

      <!-- Lock Indicator -->
      {{#if locked}}
      <div class="tom-pv-lock-indicator" title="Locked - Only GM can change emotions">
        <i class="fas fa-lock"></i>
      </div>
      {{/if}}

      <!-- Hover Hint -->
      <div class="tom-pv-hint">
        {{#if locked}}
        <i class="fas fa-lock"></i>
        {{else}}
        <i class="fas fa-theater-masks"></i>
        {{/if}}
      </div>

      <div class="tom-pv-name">{{name}}</div>
    </div>
    {{/each}}
  </div>

  <!-- Emotion Picker Popover -->
  {{#if emotionPicker}}
  <div
    class="tom-emotion-picker {{#if (gt emotionPicker.emotions.length 5)}}has-search{{/if}} {{#if emotionPicker.pickerBelow}}picker-below{{/if}}"
    style="left: {{emotionPicker.x}}px; top: {{emotionPicker.y}}px;">
    <div class="tom-picker-header">
      <span>{{emotionPicker.character.name}}</span>
      <div class="tom-picker-actions">
        <button class="tom-btn-icon small tom-btn-palette" data-action="open-border-picker" title="Border Style"><i
            class="fas fa-palette"></i></button>
        <button class="tom-btn-icon small" data-action="close-picker"><i class="fas fa-times"></i></button>
      </div>
    </div>
    {{!-- Search field for 6+ emotions --}}
    {{#if (gt emotionPicker.emotions.length 5)}}
    <div class="tom-picker-search">
      <i class="fas fa-search"></i>
      <input type="text" class="tom-picker-search-input" placeholder="Search emotions...">
    </div>
    {{/if}}
    <div class="tom-picker-grid">

      {{#each emotionPicker.emotions}}
      <div
        class="tom-picker-item {{#if (eq ../emotionPicker.character.currentState key)}}active{{/if}} {{#if isFavorite}}is-favorite{{/if}}"
        data-action="select-emotion" data-state="{{key}}" data-path="{{path}}"
        title="{{key}}{{#if isFavorite}} (Favorite){{/if}}">
        <button class="tom-emotion-fav-btn {{#if isFavorite}}active{{/if}}" data-action="toggle-emotion-favorite"
          data-state="{{key}}" title="{{#if isFavorite}}Remove from favorites{{else}}Add to favorites{{/if}}">
          <i class="{{#if isFavorite}}fas{{else}}far{{/if}} fa-star"></i>
        </button>
        <img src="{{path}}">
        <span class="tom-picker-label">{{key}}</span>
      </div>
      {{/each}}
    </div>
  </div>
  {{/if}}

  {{!-- Preview panel - MUST be outside emotion-picker to avoid transform containment --}}
  {{#if emotionPicker}}
  <div class="tom-picker-preview" style="display: none;">
    <img src="" alt="Preview">
    <span class="tom-picker-preview-label"></span>
  </div>
  {{/if}}

  <!-- Border Picker Popover -->
  {{#if borderPicker}}
  <div class="tom-border-picker {{#if borderPicker.pickerBelow}}picker-below{{/if}}"
    style="left: {{borderPicker.x}}px; top: {{borderPicker.y}}px;">
    <div class="tom-picker-header">
      <span>Border Style</span>
      <button class="tom-btn-icon small" data-action="close-border-picker"><i class="fas fa-times"></i></button>
    </div>
    <div class="tom-picker-back" data-action="back-to-emotions">
      <i class="fas fa-arrow-left"></i> Back to Emotions
    </div>

    {{!-- Solid Colors --}}
    <div class="tom-border-category">
      <h4>Solid</h4>
      <div class="tom-border-grid">
        {{#each borderPicker.solid}}
        <div class="tom-border-option {{#if active}}active{{/if}}" data-action="select-border" data-preset="{{key}}"
          data-type="solid" style="--option-color: {{color}}" title="{{name}}">
        </div>
        {{/each}}
      </div>
    </div>

    {{!-- Gradients --}}
    <div class="tom-border-category">
      <h4>Gradient</h4>
      <div class="tom-border-grid">
        {{#each borderPicker.gradient}}
        <div class="tom-border-option {{#if active}}active{{/if}}" data-action="select-border" data-preset="{{key}}"
          data-type="gradient" title="{{name}}">
        </div>
        {{/each}}
      </div>
    </div>

    {{!-- Animated --}}
    <div class="tom-border-category">
      <h4>Animated</h4>
      <div class="tom-border-grid">
        {{#each borderPicker.animated}}
        <div class="tom-border-option {{#if active}}active{{/if}}" data-action="select-border" data-preset="{{key}}"
          data-type="animated" style="--option-color: {{color}}" title="{{name}}">
        </div>
        {{/each}}
      </div>
    </div>

    {{!-- Styled --}}
    <div class="tom-border-category">
      <h4>Styled</h4>
      <div class="tom-border-grid">
        {{#each borderPicker.styled}}
        <div class="tom-border-option {{#if active}}active{{/if}}" data-action="select-border" data-preset="{{key}}"
          data-type="styled" style="--option-color: {{color}}" title="{{name}}">
        </div>
        {{/each}}
      </div>
    </div>
  </div>
  {{/if}}

</div>