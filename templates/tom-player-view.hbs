<div class="tom-player-view {{#if active}}active{{/if}} {{#if castOnlyMode}}cast-only-mode{{/if}}" data-scene-id="{{scene.id}}">

  <!-- ═══════════════════════════════════════════════════════════════
       BACKGROUND LAYER (com suporte a transições)
       Hidden in Cast-Only Mode for transparent overlay on battlemap
       ═══════════════════════════════════════════════════════════════ -->
  {{#unless castOnlyMode}}
  <div class="tom-pv-background">
    {{#if scene}}
      {{#if (eq scene.bgType 'video')}}
        <video class="tom-pv-bg-media" src="{{scene.background}}" muted loop autoplay playsinline disablepictureinpicture></video>
      {{else}}
        <img src="{{scene.background}}" class="tom-pv-bg-media">
      {{/if}}
    {{else}}
      <div class="tom-pv-placeholder"></div>
    {{/if}}
  </div>

  <!-- ═══════════════════════════════════════════════════════════════
       OVERLAY LAYER (Vignette & Effects)
       ═══════════════════════════════════════════════════════════════ -->
  <div class="tom-pv-overlay"></div>
  {{/unless}}

  <!-- ═══════════════════════════════════════════════════════════════
       CAST LAYER
       ═══════════════════════════════════════════════════════════════ -->
  <div class="tom-pv-cast"
       data-preset="{{layout.preset}}"
       style="--cast-size: {{layout.size}}; --cast-spacing: {{layout.spacing}}px; --cast-offset-x: {{layout.offsetX}}vh; --cast-offset-y: {{layout.offsetY}}vh;">
    {{#each cast}}
      <div class="tom-pv-character {{#if locked}}is-locked{{/if}}"
           data-id="{{id}}"
           data-action="character-click">
        <div class="tom-pv-portrait" data-border="{{borderStyle}}">
          <img src="{{image}}" alt="{{name}}">
        </div>

        <!-- Lock Indicator -->
        {{#if locked}}
          <div class="tom-pv-lock-indicator" title="Locked - Only GM can change emotions">
            <i class="fas fa-lock"></i>
          </div>
        {{/if}}

        <!-- Hover Hint -->
        <div class="tom-pv-hint">
          {{#if locked}}
            <i class="fas fa-lock"></i>
          {{else}}
            <i class="fas fa-theater-masks"></i>
          {{/if}}
        </div>

        <div class="tom-pv-name">{{name}}</div>
      </div>
    {{/each}}
  </div>

  <!-- Emotion Picker Popover -->
  {{#if emotionPicker}}
    <div class="tom-emotion-picker {{#if (gt emotionPicker.emotions.length 5)}}has-search{{/if}} {{#if emotionPicker.pickerBelow}}picker-below{{/if}}" style="left: {{emotionPicker.x}}px; top: {{emotionPicker.y}}px;">
      <div class="tom-picker-header">
        <span>{{emotionPicker.character.name}}</span>
        <div class="tom-picker-actions">
          <button class="tom-btn-icon small tom-btn-palette" data-action="open-border-picker" title="Border Style"><i class="fas fa-palette"></i></button>
          <button class="tom-btn-icon small" data-action="close-picker"><i class="fas fa-times"></i></button>
        </div>
      </div>
      {{!-- Search field for 6+ emotions --}}
      {{#if (gt emotionPicker.emotions.length 5)}}
        <div class="tom-picker-search">
          <i class="fas fa-search"></i>
          <input type="text" class="tom-picker-search-input" placeholder="Search emotions...">
        </div>
      {{/if}}
      <div class="tom-picker-grid">
        {{!-- Emotions are already sorted: favorites first, then alphabetically --}}
        {{#each emotionPicker.emotions}}
          <div class="tom-picker-item {{#if (eq ../emotionPicker.character.currentState key)}}active{{/if}} {{#if isFavorite}}is-favorite{{/if}}"
               data-action="select-emotion"
               data-state="{{key}}"
               data-path="{{path}}"
               title="{{key}}{{#if isFavorite}} (Favorite){{/if}}">
            <button class="tom-emotion-fav-btn {{#if isFavorite}}active{{/if}}" data-action="toggle-emotion-favorite" data-state="{{key}}" title="{{#if isFavorite}}Remove from favorites{{else}}Add to favorites{{/if}}">
              <i class="{{#if isFavorite}}fas{{else}}far{{/if}} fa-star"></i>
            </button>
            <img src="{{path}}">
            <span class="tom-picker-label">{{key}}</span>
          </div>
        {{/each}}
      </div>
    </div>
  {{/if}}

  {{!-- Preview panel - MUST be outside emotion-picker to avoid transform containment --}}
  {{#if emotionPicker}}
    <div class="tom-picker-preview" style="display: none;">
      <img src="" alt="Preview">
      <span class="tom-picker-preview-label"></span>
    </div>
  {{/if}}

  <!-- Border Picker Popover -->
  {{#if borderPicker}}
    <div class="tom-border-picker {{#if borderPicker.pickerBelow}}picker-below{{/if}}" style="left: {{borderPicker.x}}px; top: {{borderPicker.y}}px;">
      <div class="tom-picker-header">
        <span>Border Style</span>
        <button class="tom-btn-icon small" data-action="close-border-picker"><i class="fas fa-times"></i></button>
      </div>
      <div class="tom-picker-back" data-action="back-to-emotions">
        <i class="fas fa-arrow-left"></i> Back to Emotions
      </div>

      {{!-- Solid Colors --}}
      <div class="tom-border-category">
        <h4>Solid</h4>
        <div class="tom-border-grid">
          {{#each borderPicker.solid}}
            <div class="tom-border-option {{#if active}}active{{/if}}"
                 data-action="select-border"
                 data-preset="{{key}}"
                 data-type="solid"
                 style="--option-color: {{color}}"
                 title="{{name}}">
            </div>
          {{/each}}
        </div>
      </div>

      {{!-- Gradients --}}
      <div class="tom-border-category">
        <h4>Gradient</h4>
        <div class="tom-border-grid">
          {{#each borderPicker.gradient}}
            <div class="tom-border-option {{#if active}}active{{/if}}"
                 data-action="select-border"
                 data-preset="{{key}}"
                 data-type="gradient"
                 title="{{name}}">
            </div>
          {{/each}}
        </div>
      </div>

      {{!-- Animated --}}
      <div class="tom-border-category">
        <h4>Animated</h4>
        <div class="tom-border-grid">
          {{#each borderPicker.animated}}
            <div class="tom-border-option {{#if active}}active{{/if}}"
                 data-action="select-border"
                 data-preset="{{key}}"
                 data-type="animated"
                 style="--option-color: {{color}}"
                 title="{{name}}">
            </div>
          {{/each}}
        </div>
      </div>

      {{!-- Styled --}}
      <div class="tom-border-category">
        <h4>Styled</h4>
        <div class="tom-border-grid">
          {{#each borderPicker.styled}}
            <div class="tom-border-option {{#if active}}active{{/if}}"
                 data-action="select-border"
                 data-preset="{{key}}"
                 data-type="styled"
                 style="--option-color: {{color}}"
                 title="{{name}}">
            </div>
          {{/each}}
        </div>
      </div>
    </div>
  {{/if}}

</div>
